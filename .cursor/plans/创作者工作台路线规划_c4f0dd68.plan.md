---
name: åˆ›ä½œè€…å·¥ä½œå°è·¯çº¿è§„åˆ’
overview: å°† WriteNow ä»"æ–‡å­—åˆ›ä½œ IDE"æ‰©å±•ä¸º"åˆ›ä½œè€…å·¥ä½œå°"ï¼Œå½¢æˆ æ–‡å­— â†’ éŸ³é¢‘ â†’ è§†é¢‘ çš„å¤šæ¨¡æ€å†…å®¹é—­ç¯ï¼Œé€šè¿‡å››å¤§èƒ½åŠ›æ¨¡å—ï¼ˆé•¿æ–‡åˆ›ä½œã€è¯­éŸ³æ’­å®¢ã€å¬ä¹¦ã€è§†é¢‘åˆ†é•œï¼‰è¦†ç›–å®Œæ•´åˆ›ä½œé“¾è·¯ã€‚
todos:
  - id: poc-fish-speech
    content: "PoC: Fish-Speech (OpenAudio) æœ¬åœ°é›†æˆï¼ŒéªŒè¯ä¸­æ–‡æ•ˆæœ"
    status: pending
  - id: sprint-a-tts
    content: "Sprint A: TTS æœåŠ¡æŠ½è±¡ + ä¸€é”®æœ—è¯» + è¯­éŸ³é¢æ¿"
    status: pending
  - id: sprint-b-audiobook
    content: "Sprint B: å¬ä¹¦æ’­æ”¾å™¨ + æ’­å®¢ç¼–è¾‘å™¨"
    status: pending
  - id: sprint-c-storyboard
    content: "Sprint C: åˆ†é•œ SKILL + åˆ†é•œç¼–è¾‘å™¨ Widget"
    status: pending
  - id: sprint-d-longform
    content: "Sprint D: é•¿æ–‡å¢å¼ºï¼ˆç³»åˆ—ç®¡ç† + è·¨ç« ä¸€è‡´æ€§ï¼‰"
    status: pending
  - id: update-spec
    content: æ›´æ–° writenow-spec.md çº³å…¥å¤šæ¨¡æ€æ„¿æ™¯
    status: pending
isProject: false
---

# WriteNow åˆ›ä½œè€…å·¥ä½œå°å‘å±•è·¯çº¿ï¼ˆè¯¦ç»†ç‰ˆï¼‰

## ä¸€ã€æˆ˜ç•¥å®šä½ä¸æ¶æ„å…¨æ™¯

### 1.1 äº§å“å®šä½å‡çº§

ä»"AI é©±åŠ¨çš„æ–‡å­—åˆ›ä½œ IDE"å‡çº§ä¸º**"åˆ›ä½œè€…çš„å…¨é“¾è·¯å·¥ä½œå°"**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WriteNow åˆ›ä½œè€…å·¥ä½œå°                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚   æ–‡å­—åˆ›ä½œ   â”‚ â”€â”€â”€â†’ â”‚   éŸ³é¢‘åˆ¶ä½œ   â”‚ â”€â”€â”€â†’ â”‚   è§†é¢‘ç­–åˆ’   â”‚                â”‚
â”‚   â”‚             â”‚      â”‚             â”‚      â”‚             â”‚                â”‚
â”‚   â”‚ â€¢ é•¿æ–‡/ç³»åˆ—  â”‚      â”‚ â€¢ è¯­éŸ³æœ—è¯»   â”‚      â”‚ â€¢ åˆ†é•œç”Ÿæˆ   â”‚                â”‚
â”‚   â”‚ â€¢ è¿è½½å°è¯´   â”‚      â”‚ â€¢ æ’­å®¢åˆ¶ä½œ   â”‚      â”‚ â€¢ å­—å¹•å¯¼å‡º   â”‚                â”‚
â”‚   â”‚ â€¢ AI æ”¹å†™    â”‚      â”‚ â€¢ å¬ä¹¦ç”Ÿæˆ   â”‚      â”‚ â€¢ é…å›¾å»ºè®®   â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                    â”‚                    â”‚                        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                               â–¼                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                        å…±äº«åŸºç¡€è®¾æ–½å±‚                                 â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚   â”‚  â”‚ é¡¹ç›®ç®¡ç† â”‚ â”‚ äººç‰©å¡ç‰‡ â”‚ â”‚ çŸ¥è¯†å›¾è°± â”‚ â”‚ SKILL   â”‚ â”‚ ç‰ˆæœ¬æ§åˆ¶ â”‚       â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚   â”‚  â”‚ RAGæ£€ç´¢  â”‚ â”‚ å…¨æ–‡æœç´¢ â”‚ â”‚ ç”¨æˆ·è®°å¿† â”‚ â”‚ å¤šæ ¼å¼å¯¼å‡ºâ”‚ â”‚ äº‘åŒæ­¥   â”‚       â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ¶æ„æ‰©å±•ï¼ˆåŸºäºç°æœ‰ Theia + Standalone åŒæ ˆï¼‰

```
WriteNow/
â”œâ”€â”€ writenow-theia/                          # Theia ç‰ˆæœ¬ï¼ˆProductionï¼‰
â”‚   â””â”€â”€ writenow-core/
â”‚       â”œâ”€â”€ src/node/services/
â”‚       â”‚   â”œâ”€â”€ audio-service.ts             # [æ–°å¢] TTS/STT æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ podcast-service.ts           # [æ–°å¢] æ’­å®¢ç¼–è¾‘æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ audiobook-service.ts         # [æ–°å¢] å¬ä¹¦æœåŠ¡
â”‚       â”‚   â””â”€â”€ storyboard-service.ts        # [æ–°å¢] åˆ†é•œæœåŠ¡
â”‚       â””â”€â”€ src/browser/
â”‚           â”œâ”€â”€ audio-panel/                 # [æ–°å¢] è¯­éŸ³é¢æ¿ Widget
â”‚           â”œâ”€â”€ podcast-editor/              # [æ–°å¢] æ’­å®¢ç¼–è¾‘å™¨ Widget
â”‚           â”œâ”€â”€ audiobook-player/            # [æ–°å¢] å¬ä¹¦æ’­æ”¾å™¨ Widget
â”‚           â””â”€â”€ storyboard-editor/           # [æ–°å¢] åˆ†é•œç¼–è¾‘å™¨ Widget
â”‚
â”œâ”€â”€ writenow-frontend/                       # Standalone å‰ç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ features/
â”‚       â”‚   â”œâ”€â”€ audio-panel/                 # [æ–°å¢] è¯­éŸ³é¢æ¿
â”‚       â”‚   â”œâ”€â”€ podcast-editor/              # [æ–°å¢] æ’­å®¢ç¼–è¾‘å™¨
â”‚       â”‚   â”œâ”€â”€ audiobook-player/            # [æ–°å¢] å¬ä¹¦æ’­æ”¾å™¨
â”‚       â”‚   â””â”€â”€ storyboard-editor/           # [æ–°å¢] åˆ†é•œç¼–è¾‘å™¨
â”‚       â”œâ”€â”€ stores/
â”‚       â”‚   â”œâ”€â”€ audioStore.ts                # [æ–°å¢] éŸ³é¢‘çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ podcastStore.ts              # [æ–°å¢] æ’­å®¢çŠ¶æ€
â”‚       â”‚   â””â”€â”€ storyboardStore.ts           # [æ–°å¢] åˆ†é•œçŠ¶æ€
â”‚       â””â”€â”€ lib/
â”‚           â””â”€â”€ audio/                       # [æ–°å¢] éŸ³é¢‘å¤„ç†å·¥å…·
â”‚
â”œâ”€â”€ electron/
â”‚   â””â”€â”€ skills/packages/pkg.writenow.builtin/1.0.0/skills/
â”‚       â”œâ”€â”€ podcast-script/                  # [æ–°å¢] æ’­å®¢è„šæœ¬ SKILL
â”‚       â”œâ”€â”€ audiobook-optimize/              # [æ–°å¢] å¬ä¹¦ä¼˜åŒ– SKILL
â”‚       â”œâ”€â”€ storyboard-generate/             # [æ–°å¢] åˆ†é•œç”Ÿæˆ SKILL
â”‚       â”œâ”€â”€ series-outline/                  # [æ–°å¢] ç³»åˆ—å¤§çº² SKILL
â”‚       â””â”€â”€ cross-chapter-check/             # [æ–°å¢] è·¨ç« æ£€æŸ¥ SKILL
â”‚
â””â”€â”€ src/types/
    â””â”€â”€ ipc-generated.ts                     # IPC å¥‘çº¦ï¼ˆéœ€æ‰©å±•ï¼‰
```

---

## äºŒã€æ¨¡å— 1ï¼šè¯­éŸ³æœ—è¯» / TTS æœåŠ¡ï¼ˆSprint Aï¼‰

### 2.1 äº§å“éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼š
- ä½œä¸ºå…¬ä¼—å·ä½œè€…ï¼Œæˆ‘æƒ³æŠŠæ–‡ç« ä¸€é”®è½¬æˆè¯­éŸ³ï¼Œå‘åˆ°å–œé©¬æ‹‰é›…/å°å®‡å®™
- ä½œä¸ºçŸ¥è¯†åšä¸»ï¼Œæˆ‘æƒ³é¢„è§ˆæ–‡ç« çš„æœ—è¯»æ•ˆæœï¼Œè°ƒæ•´èŠ‚å¥
- ä½œä¸º Pro ç”¨æˆ·ï¼Œæˆ‘æƒ³ç”¨é«˜è´¨é‡éŸ³è‰²ï¼ˆç±»ä¼¼ ElevenLabsï¼‰

**ç”¨æˆ·æ“ä½œè·¯å¾„**ï¼š
```
1. é€‰ä¸­æ–‡å­—ï¼ˆæˆ–å…¨æ–‡ï¼‰
2. ç‚¹å‡» "æœ—è¯»" æŒ‰é’® / å¿«æ·é”® Cmd+Shift+R
3. å¼¹å‡ºè¯­éŸ³é¢æ¿ï¼š
   - é€‰æ‹©éŸ³è‰²ï¼ˆæœ¬åœ°/äº‘ç«¯ï¼‰
   - è°ƒæ•´è¯­é€Ÿï¼ˆ0.5x - 2.0xï¼‰
   - é¢„è§ˆæ’­æ”¾
4. å¯¼å‡º MP3/WAV
```

### 2.2 äº¤äº’è®¾è®¡

**2.2.1 è¯­éŸ³é¢æ¿ UIï¼ˆAudioPanelï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”Š è¯­éŸ³æœ—è¯»                        [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  éŸ³è‰²é€‰æ‹©                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ™ï¸ æ™“æ™“ï¼ˆå¥³å£°Â·æ¸©æŸ”ï¼‰          â–¼ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  è¯­é€Ÿ   â”â”â”â”â”â”â”â—â”â”â”â”â”â”  1.2x           â”‚
â”‚                                         â”‚
â”‚  æƒ…æ„Ÿï¼ˆProï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ˜Š å¹³é™                       â–¼ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ“ å¾…æœ—è¯»æ–‡æœ¬                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¿™æ˜¯ä¸€æ®µç¤ºä¾‹æ–‡å­—ï¼Œç”¨äºé¢„è§ˆæœ—è¯»   â”‚   â”‚
â”‚  â”‚ æ•ˆæœã€‚ä½ å¯ä»¥è°ƒæ•´ä¸Šæ–¹çš„å‚æ•°...    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â±ï¸ é¢„ä¼°æ—¶é•¿ï¼š2 åˆ† 15 ç§’                â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  â—€â—€  [â–¶ é¢„è§ˆæ’­æ”¾]  â–¶â–¶    00:00 / 02:15 â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“¥ å¯¼å‡º MP3 â”‚  â”‚ ğŸ“¥ å¯¼å‡º WAV     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2.2.2 å¿«æ·æ“ä½œï¼ˆç¼–è¾‘å™¨å·¥å…·æ ï¼‰**

åœ¨ TipTap æµ®åŠ¨å·¥å…·æ å¢åŠ  "ğŸ”Š" æŒ‰é’®ï¼š
- é€‰ä¸­æ–‡å­—åæ˜¾ç¤º
- ç‚¹å‡»ç›´æ¥ç”¨é»˜è®¤éŸ³è‰²æœ—è¯»ï¼ˆFree ç”¨æˆ·ç”¨æœ¬åœ°ï¼ŒPro ç”¨äº‘ç«¯ï¼‰
- é•¿æŒ‰å¼¹å‡ºå®Œæ•´è¯­éŸ³é¢æ¿

### 2.3 æŠ€æœ¯å®ç°

**2.3.1 IPC å¥‘çº¦æ‰©å±•ï¼ˆ`src/types/ipc-generated.ts`ï¼‰**

```typescript
// ========== TTS æœåŠ¡å¥‘çº¦ ==========

/** éŸ³è‰²ä¿¡æ¯ */
export type Voice = {
  id: string;                      // å¦‚ "fish:zh-CN-XiaoxiaoNeural"
  name: string;                    // æ˜¾ç¤ºåç§°
  language: string;                // è¯­è¨€ä»£ç 
  gender: 'male' | 'female';
  provider: 'local' | 'elevenlabs' | 'azure';
  tier: 'free' | 'pro';            // å¥—é¤é™åˆ¶
  sampleUrl?: string;              // è¯•å¬éŸ³é¢‘ URL
};

/** TTS åˆæˆè¯·æ±‚ */
export type TTSSynthesizeRequest = {
  text: string;                    // å¾…åˆæˆæ–‡æœ¬
  voiceId: string;                 // éŸ³è‰² ID
  speed?: number;                  // è¯­é€Ÿ (0.5-2.0, é»˜è®¤ 1.0)
  emotion?: string;                // æƒ…æ„Ÿæ ‡ç­¾ï¼ˆProï¼‰
  format?: 'mp3' | 'wav';          // è¾“å‡ºæ ¼å¼
};

/** TTS åˆæˆå“åº” */
export type TTSSynthesizeResponse = {
  audioPath: string;               // ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„
  durationMs: number;              // æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  charCount: number;               // å­—ç¬¦æ•°
};

/** TTS æ—¶é•¿ä¼°ç®— */
export type TTSEstimateRequest = { text: string; speed?: number; };
export type TTSEstimateResponse = { durationMs: number; charCount: number; };

// IPC é€šé“
// 'tts:voices:list'    â†’ Voice[]
// 'tts:synthesize'     â†’ TTSSynthesizeResponse
// 'tts:estimate'       â†’ TTSEstimateResponse
// 'tts:model:status'   â†’ { ready: boolean; downloading?: boolean; progress?: number }
// 'tts:model:download' â†’ void (è§¦å‘ä¸‹è½½)
```

**2.3.2 åç«¯æœåŠ¡ï¼ˆ`writenow-core/src/node/services/audio-service.ts`ï¼‰**

```typescript
import { injectable, inject } from 'inversify';
import { ILogger } from '@theia/core';
import { TheiaInvokeRegistry } from '../theia-invoke-adapter';

// TTS Provider æ¥å£ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
export interface TTSProvider {
  readonly id: string;
  readonly tier: 'free' | 'pro';
  
  getVoices(): Promise<Voice[]>;
  synthesize(request: TTSSynthesizeRequest): Promise<TTSSynthesizeResponse>;
  estimateDuration(text: string, speed: number): number;
  
  // æœ¬åœ°æ¨¡å‹ç‰¹æœ‰
  isModelReady?(): boolean;
  downloadModel?(): Promise<void>;
  getDownloadProgress?(): number;
}

@injectable()
export class AudioService {
  private providers: Map<string, TTSProvider> = new Map();
  
  constructor(
    @inject(ILogger) private readonly logger: ILogger,
    @inject(FishSpeechProvider) fishSpeech: FishSpeechProvider,
    @inject(ElevenLabsProvider) elevenLabs: ElevenLabsProvider,
  ) {
    this.providers.set('fish', fishSpeech);
    this.providers.set('elevenlabs', elevenLabs);
  }
  
  /** æ³¨å†Œ IPC å¤„ç†å™¨ */
  register(registry: TheiaInvokeRegistry): void {
    registry.handleInvoke('tts:voices:list', async () => {
      const voices: Voice[] = [];
      for (const provider of this.providers.values()) {
        voices.push(...await provider.getVoices());
      }
      return voices;
    });
    
    registry.handleInvoke('tts:synthesize', async (_evt, payload) => {
      const req = payload as TTSSynthesizeRequest;
      const providerId = this.getProviderFromVoiceId(req.voiceId);
      const provider = this.providers.get(providerId);
      if (!provider) throw createIpcError('NOT_FOUND', `Provider not found: ${providerId}`);
      return provider.synthesize(req);
    });
    
    registry.handleInvoke('tts:estimate', async (_evt, payload) => {
      const { text, speed = 1.0 } = payload as TTSEstimateRequest;
      // ä¸­æ–‡çº¦ 4 å­—/ç§’ï¼Œè‹±æ–‡çº¦ 150 è¯/åˆ†é’Ÿ
      const charCount = text.length;
      const baseRate = 4; // å­—/ç§’
      const durationMs = Math.round((charCount / baseRate / speed) * 1000);
      return { durationMs, charCount };
    });
    
    // æœ¬åœ°æ¨¡å‹çŠ¶æ€
    registry.handleInvoke('tts:model:status', async () => {
      const fish = this.providers.get('fish') as FishSpeechProvider;
      return {
        ready: fish.isModelReady(),
        downloading: fish.isDownloading(),
        progress: fish.getDownloadProgress(),
      };
    });
    
    registry.handleInvoke('tts:model:download', async () => {
      const fish = this.providers.get('fish') as FishSpeechProvider;
      await fish.downloadModel();
    });
  }
  
  private getProviderFromVoiceId(voiceId: string): string {
    // voiceId æ ¼å¼: "provider:voiceName"
    return voiceId.split(':')[0];
  }
}
```

**2.3.3 Fish-Speech æœ¬åœ° Providerï¼ˆ`fish-speech-provider.ts`ï¼‰**

```typescript
import { injectable, inject } from 'inversify';
import * as path from 'path';
import * as fs from 'fs/promises';
import { spawn } from 'child_process';

@injectable()
export class FishSpeechProvider implements TTSProvider {
  readonly id = 'fish';
  readonly tier = 'free' as const;
  
  private modelDir: string;
  private modelReady = false;
  private downloading = false;
  private downloadProgress = 0;
  
  constructor(@inject('DataDir') dataDir: string) {
    this.modelDir = path.join(dataDir, 'models', 'fish-speech');
  }
  
  async getVoices(): Promise<Voice[]> {
    // Fish-Speech å†…ç½®éŸ³è‰²
    return [
      { id: 'fish:zh-female-1', name: 'æ™“æ™“ï¼ˆå¥³å£°Â·æ¸©æŸ”ï¼‰', language: 'zh-CN', gender: 'female', provider: 'local', tier: 'free' },
      { id: 'fish:zh-male-1', name: 'äº‘æ‰¬ï¼ˆç”·å£°Â·æ²‰ç¨³ï¼‰', language: 'zh-CN', gender: 'male', provider: 'local', tier: 'free' },
      { id: 'fish:en-female-1', name: 'Emma (Female)', language: 'en-US', gender: 'female', provider: 'local', tier: 'free' },
      { id: 'fish:en-male-1', name: 'James (Male)', language: 'en-US', gender: 'male', provider: 'local', tier: 'free' },
    ];
  }
  
  async synthesize(request: TTSSynthesizeRequest): Promise<TTSSynthesizeResponse> {
    if (!this.modelReady) {
      throw createIpcError('MODEL_NOT_READY', 'TTS model not downloaded');
    }
    
    const outputPath = path.join(this.modelDir, 'output', `${Date.now()}.${request.format || 'mp3'}`);
    await fs.mkdir(path.dirname(outputPath), { recursive: true });
    
    // è°ƒç”¨ Fish-Speech CLI æˆ– Python API
    await this.runFishSpeech(request.text, request.voiceId, outputPath, request.speed);
    
    const durationMs = this.estimateDuration(request.text, request.speed || 1.0);
    return { audioPath: outputPath, durationMs, charCount: request.text.length };
  }
  
  private async runFishSpeech(text: string, voiceId: string, outputPath: string, speed: number): Promise<void> {
    // ä½¿ç”¨ fish-speech CLI æˆ– HTTP API
    // å®é™…å®ç°éœ€æ ¹æ® Fish-Speech çš„å…·ä½“æ¥å£è°ƒæ•´
    return new Promise((resolve, reject) => {
      const proc = spawn('python', [
        '-m', 'fish_speech.tools.api_server',
        '--text', text,
        '--voice', voiceId.split(':')[1],
        '--output', outputPath,
        '--speed', String(speed),
      ], { cwd: this.modelDir });
      
      proc.on('close', (code) => {
        if (code === 0) resolve();
        else reject(new Error(`Fish-Speech exited with code ${code}`));
      });
    });
  }
  
  estimateDuration(text: string, speed: number): number {
    const charCount = text.length;
    const baseRate = 4; // ä¸­æ–‡çº¦ 4 å­—/ç§’
    return Math.round((charCount / baseRate / speed) * 1000);
  }
  
  isModelReady(): boolean { return this.modelReady; }
  isDownloading(): boolean { return this.downloading; }
  getDownloadProgress(): number { return this.downloadProgress; }
  
  async downloadModel(): Promise<void> {
    if (this.downloading) return;
    this.downloading = true;
    this.downloadProgress = 0;
    
    try {
      // ä¸‹è½½ Fish-Speech æ¨¡å‹ï¼ˆçº¦ 1.2GBï¼‰
      // ä½¿ç”¨ huggingface_hub æˆ–ç›´æ¥ HTTP ä¸‹è½½
      // è¿›åº¦é€šè¿‡äº‹ä»¶å‘é€åˆ°å‰ç«¯
      await this.downloadFromHuggingFace('fishaudio/fish-speech-1.5', this.modelDir, (progress) => {
        this.downloadProgress = progress;
      });
      this.modelReady = true;
    } finally {
      this.downloading = false;
    }
  }
}
```

**2.3.4 å‰ç«¯ç»„ä»¶ï¼ˆ`writenow-frontend/src/features/audio-panel/AudioPanel.tsx`ï¼‰**

```tsx
import { useState, useEffect } from 'react';
import { useAudioStore } from '@/stores/audioStore';
import { invoke } from '@/lib/rpc';
import { Select, Slider, Button } from '@/components/ui';

export function AudioPanel() {
  const { 
    selectedText, 
    voices, 
    selectedVoice, 
    speed, 
    isPlaying,
    audioUrl,
    setVoice, 
    setSpeed,
    setAudioUrl,
  } = useAudioStore();
  
  const [estimatedDuration, setEstimatedDuration] = useState(0);
  const [synthesizing, setSynthesizing] = useState(false);
  
  // åŠ è½½éŸ³è‰²åˆ—è¡¨
  useEffect(() => {
    invoke('tts:voices:list', {}).then((voices) => {
      useAudioStore.getState().setVoices(voices);
    });
  }, []);
  
  // ä¼°ç®—æ—¶é•¿
  useEffect(() => {
    if (selectedText) {
      invoke('tts:estimate', { text: selectedText, speed }).then((res) => {
        setEstimatedDuration(res.durationMs);
      });
    }
  }, [selectedText, speed]);
  
  const handleSynthesize = async () => {
    if (!selectedText || !selectedVoice) return;
    
    setSynthesizing(true);
    try {
      const result = await invoke('tts:synthesize', {
        text: selectedText,
        voiceId: selectedVoice.id,
        speed,
        format: 'mp3',
      });
      setAudioUrl(`file://${result.audioPath}`);
    } finally {
      setSynthesizing(false);
    }
  };
  
  const handleExport = async (format: 'mp3' | 'wav') => {
    // è°ƒç”¨å¯¼å‡ºæœåŠ¡
    const result = await invoke('tts:synthesize', {
      text: selectedText,
      voiceId: selectedVoice.id,
      speed,
      format,
    });
    // æ‰“å¼€ä¿å­˜å¯¹è¯æ¡†æˆ–ç›´æ¥ä¸‹è½½
    window.electronAPI?.showItemInFolder(result.audioPath);
  };
  
  return (
    <div className="audio-panel p-4 space-y-4">
      <h3 className="text-lg font-semibold">ğŸ”Š è¯­éŸ³æœ—è¯»</h3>
      
      {/* éŸ³è‰²é€‰æ‹© */}
      <div>
        <label className="text-sm text-muted-foreground">éŸ³è‰²é€‰æ‹©</label>
        <Select
          value={selectedVoice?.id}
          onValueChange={(id) => setVoice(voices.find(v => v.id === id))}
          options={voices.map(v => ({
            value: v.id,
            label: `${v.name} (${v.tier === 'pro' ? 'Pro' : 'å…è´¹'})`,
          }))}
        />
      </div>
      
      {/* è¯­é€Ÿè°ƒèŠ‚ */}
      <div>
        <label className="text-sm text-muted-foreground">è¯­é€Ÿ: {speed.toFixed(1)}x</label>
        <Slider
          min={0.5}
          max={2.0}
          step={0.1}
          value={[speed]}
          onValueChange={([v]) => setSpeed(v)}
        />
      </div>
      
      {/* å¾…æœ—è¯»æ–‡æœ¬é¢„è§ˆ */}
      <div>
        <label className="text-sm text-muted-foreground">å¾…æœ—è¯»æ–‡æœ¬</label>
        <div className="border rounded p-2 max-h-32 overflow-y-auto text-sm">
          {selectedText || 'è¯·åœ¨ç¼–è¾‘å™¨ä¸­é€‰ä¸­æ–‡å­—'}
        </div>
      </div>
      
      {/* é¢„ä¼°æ—¶é•¿ */}
      <div className="text-sm text-muted-foreground">
        â±ï¸ é¢„ä¼°æ—¶é•¿ï¼š{formatDuration(estimatedDuration)}
      </div>
      
      {/* æ’­æ”¾æ§åˆ¶ */}
      {audioUrl && (
        <audio controls src={audioUrl} className="w-full" />
      )}
      
      {/* æ“ä½œæŒ‰é’® */}
      <div className="flex gap-2">
        <Button 
          onClick={handleSynthesize} 
          disabled={!selectedText || synthesizing}
        >
          {synthesizing ? 'ç”Ÿæˆä¸­...' : 'â–¶ é¢„è§ˆæ’­æ”¾'}
        </Button>
        <Button variant="outline" onClick={() => handleExport('mp3')}>
          ğŸ“¥ å¯¼å‡º MP3
        </Button>
        <Button variant="outline" onClick={() => handleExport('wav')}>
          ğŸ“¥ å¯¼å‡º WAV
        </Button>
      </div>
    </div>
  );
}

function formatDuration(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes} åˆ† ${secs.toString().padStart(2, '0')} ç§’`;
}
```

**2.3.5 çŠ¶æ€ç®¡ç†ï¼ˆ`writenow-frontend/src/stores/audioStore.ts`ï¼‰**

```typescript
import { create } from 'zustand';

interface AudioState {
  // æ–‡æœ¬
  selectedText: string;
  setSelectedText: (text: string) => void;
  
  // éŸ³è‰²
  voices: Voice[];
  selectedVoice: Voice | null;
  setVoices: (voices: Voice[]) => void;
  setVoice: (voice: Voice | undefined) => void;
  
  // å‚æ•°
  speed: number;
  setSpeed: (speed: number) => void;
  
  // æ’­æ”¾çŠ¶æ€
  isPlaying: boolean;
  audioUrl: string | null;
  setAudioUrl: (url: string | null) => void;
  
  // æ¨¡å‹çŠ¶æ€
  modelReady: boolean;
  modelDownloading: boolean;
  modelProgress: number;
}

export const useAudioStore = create<AudioState>((set) => ({
  selectedText: '',
  setSelectedText: (text) => set({ selectedText: text }),
  
  voices: [],
  selectedVoice: null,
  setVoices: (voices) => set({ voices, selectedVoice: voices[0] || null }),
  setVoice: (voice) => set({ selectedVoice: voice || null }),
  
  speed: 1.0,
  setSpeed: (speed) => set({ speed }),
  
  isPlaying: false,
  audioUrl: null,
  setAudioUrl: (url) => set({ audioUrl: url }),
  
  modelReady: false,
  modelDownloading: false,
  modelProgress: 0,
}));
```

### 2.4 SKILLï¼šæ’­å®¢è„šæœ¬è½¬æ¢

**æ–‡ä»¶ä½ç½®**ï¼š`electron/skills/packages/pkg.writenow.builtin/1.0.0/skills/podcast-script/SKILL.md`

```yaml
---
id: builtin:podcast-script
name: è½¬æ’­å®¢è„šæœ¬
description: å°†ä¹¦é¢æ–‡ç« è½¬æ¢ä¸ºé€‚åˆå£æ’­çš„æ’­å®¢è„šæœ¬ï¼Œæ·»åŠ åœé¡¿æ ‡è®°å’Œå£è¯­åŒ–è¡¨è¾¾
version: 1.0.0
tags: [audio, transform]
kind: single
scope: builtin
packageId: pkg.writenow.builtin
modelProfile:
  tier: standard
  preferred: claude-3-5-sonnet-latest
output:
  format: plain_text
prompt:
  system: |
    ä½ æ˜¯ WriteNow çš„æ’­å®¢è„šæœ¬è½¬æ¢åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ä¹¦é¢æ–‡ç« è½¬æ¢ä¸ºé€‚åˆæœ—è¯»çš„æ’­å®¢è„šæœ¬ã€‚

    è½¬æ¢è§„åˆ™ï¼š
    1. å°†ä¹¦é¢è¯­è½¬æ¢ä¸ºå£è¯­åŒ–è¡¨è¾¾
    2. æ·»åŠ åœé¡¿æ ‡è®°ï¼š
       - [pause] = çŸ­åœé¡¿ï¼ˆ0.5ç§’ï¼‰
       - [long_pause] = é•¿åœé¡¿ï¼ˆ1.5ç§’ï¼‰
       - [breath] = æ¢æ°”åœé¡¿
    3. å¤„ç†ç‰¹æ®Šå†…å®¹ï¼š
       - æ•°å­—ï¼šè½¬ä¸ºå£è¯­å½¢å¼ï¼ˆå¦‚ "100ä¸‡" â†’ "ä¸€ç™¾ä¸‡"ï¼‰
       - ç¼©å†™ï¼šå±•å¼€ï¼ˆå¦‚ "AI" â†’ "A I" æˆ– "äººå·¥æ™ºèƒ½"ï¼‰
       - æ ‡ç‚¹ï¼šé€‚å½“è½¬æ¢ï¼ˆå¦‚ "â€”â€”" â†’ [pause]ï¼‰
    4. æ·»åŠ è¯­æ°”è¯å’Œè¿‡æ¸¡è¯ï¼Œå¢å¼ºå¬æ„Ÿ
    5. ä¿æŒåŸæ–‡æ ¸å¿ƒä¿¡æ¯ä¸å˜

    è¾“å‡ºæ ¼å¼ï¼š
    - çº¯æ–‡æœ¬ï¼ŒåŒ…å«åœé¡¿æ ‡è®°
    - ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šè¯´æ˜
  user: |
    è¯·å°†ä»¥ä¸‹æ–‡ç« è½¬æ¢ä¸ºæ’­å®¢è„šæœ¬ï¼š

    {{text}}
context_rules:
  surrounding: 0
  user_preferences: true
  style_guide: false
---
## Intent
å°†ä¹¦é¢æ–‡ç« è½¬æ¢ä¸ºé€‚åˆè¯­éŸ³æœ—è¯»çš„æ’­å®¢è„šæœ¬ï¼Œæ·»åŠ åœé¡¿æ ‡è®°å’Œå£è¯­åŒ–è¡¨è¾¾ï¼Œæå‡å¬æ„Ÿã€‚
```

---

## ä¸‰ã€æ¨¡å— 2ï¼šå¬ä¹¦åŠŸèƒ½ï¼ˆSprint Bï¼‰

### 3.1 äº§å“éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼š
- ä½œä¸ºé•¿ç¯‡å°è¯´ä½œè€…ï¼Œæˆ‘æƒ³æŠŠæ•´æœ¬ä¹¦è½¬æˆæœ‰å£°ä¹¦ï¼Œæµ‹è¯•é˜…è¯»ä½“éªŒ
- ä½œä¸ºè¯»è€…ï¼Œæˆ‘æƒ³å¬ä¹¦æ—¶èƒ½çœ‹åˆ°å½“å‰æœ—è¯»ä½ç½®
- ä½œä¸ºä½œè€…ï¼Œæˆ‘æƒ³æŒ‰ç« èŠ‚ç®¡ç†éŸ³é¢‘ï¼Œæ–¹ä¾¿åç»­ç¼–è¾‘

**ä¸æ’­å®¢çš„åŒºåˆ«**ï¼š
| ç»´åº¦ | æ’­å®¢ | å¬ä¹¦ |
|------|------|------|
| æ—¶é•¿ | 10-30 åˆ†é’Ÿ/é›† | å¯è¾¾æ•°å°æ—¶ |
| å†…å®¹ | å£è¯­åŒ–è„šæœ¬ | ä¿ç•™ä¹¦é¢è¯­ |
| ç»“æ„ | å•é›†ç‹¬ç«‹ | ç« èŠ‚å¯¼èˆª |
| äº¤äº’ | æ’­æ”¾/å¯¼å‡º | ä¹¦ç­¾/å€é€Ÿ/è¿›åº¦åŒæ­¥ |

### 3.2 äº¤äº’è®¾è®¡

**3.2.1 å¬ä¹¦æ’­æ”¾å™¨ UIï¼ˆAudiobookPlayerï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“– å¬ä¹¦æ¨¡å¼ - ã€Šæˆ‘çš„å°è¯´ã€‹                              [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚    ç¬¬ä¸‰ç« ï¼šç›¸é‡                                           â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â”‚    é‚£æ˜¯ä¸€ä¸ªé˜³å…‰æ˜åªšçš„ä¸‹åˆï¼Œå¼ ä¸‰èµ°åœ¨ç†™ç†™æ”˜æ”˜çš„è¡—é“ä¸Šã€‚     â”‚ â”‚
â”‚  â”‚    ä»–çš„ç›®å…‰è¢«ä¸€å®¶å¤æ—§çš„ä¹¦åº—å¸å¼•ï¼Œåº—é—¨å£æŒ‚ç€è¤ªè‰²çš„æ‹›ç‰Œã€‚   â”‚ â”‚
â”‚  â”‚    â–¶ã€æ¨å¼€é‚£æ‰‡å±å‘€ä½œå“çš„æœ¨é—¨ï¼Œä¸€è‚¡æ·¡æ·¡çš„å¢¨é¦™æ‰‘é¢è€Œæ¥ã€‚ã€‘â—€ â”‚ â”‚
â”‚  â”‚    ä¹¦æ¶ä¸Šæ‘†æ»¡äº†æ³›é»„çš„æ—§ä¹¦ï¼Œé˜³å…‰é€è¿‡çª—æˆ·æ´’åœ¨åœ°æ¿ä¸Š...     â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  05:32 / 45:20  â”‚
â”‚                                                                 â”‚
â”‚       â—€â—€     [â–¶ æ’­æ”¾]     â–¶â–¶        ğŸ”Š â”â”â—â”â”â”   1.2x          â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ğŸ“‘ ç« èŠ‚åˆ—è¡¨                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â—‹ ç¬¬ä¸€ç« ï¼šåºå¹•                               [12:30]     â”‚ â”‚
â”‚  â”‚  â—‹ ç¬¬äºŒç« ï¼šå¯ç¨‹                               [18:45]     â”‚ â”‚
â”‚  â”‚  â— ç¬¬ä¸‰ç« ï¼šç›¸é‡ï¼ˆæ’­æ”¾ä¸­ï¼‰                      [45:20]     â”‚ â”‚
â”‚  â”‚  â—‹ ç¬¬å››ç« ï¼šè½¬æŠ˜                               [å¾…ç”Ÿæˆ]     â”‚ â”‚
â”‚  â”‚  â—‹ ç¬¬äº”ç« ï¼šé«˜æ½®                               [å¾…ç”Ÿæˆ]     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  ğŸ”– ä¹¦ç­¾                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ ç¬¬ä¸‰ç«  05:32 "æ¨å¼€é‚£æ‰‡å±å‘€ä½œå“çš„æœ¨é—¨"      [è·³è½¬] [åˆ é™¤]â”‚ â”‚
â”‚  â”‚  â€¢ ç¬¬ä¸€ç«  08:15 "ä»–ç»ˆäºåšå‡ºäº†å†³å®š"            [è·³è½¬] [åˆ é™¤]â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  [ğŸ“¥ å¯¼å‡ºå…¨ä¹¦éŸ³é¢‘]  [ğŸ“¥ å¯¼å‡ºå½“å‰ç« èŠ‚]  [ğŸ”„ é‡æ–°ç”Ÿæˆå½“å‰ç« èŠ‚]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3.2.2 è¿›åº¦åŒæ­¥**

ç¼–è¾‘å™¨ä¸­é«˜äº®å½“å‰æœ—è¯»å¥å­ï¼š
- å½“å‰å¥å­ï¼šé»„è‰²èƒŒæ™¯ + ç²—ä½“
- å·²è¯»å¥å­ï¼šæ·¡ç°è‰²
- æœªè¯»å¥å­ï¼šæ­£å¸¸é¢œè‰²

### 3.3 æŠ€æœ¯å®ç°

**3.3.1 IPC å¥‘çº¦æ‰©å±•**

```typescript
// ========== å¬ä¹¦æœåŠ¡å¥‘çº¦ ==========

/** ç« èŠ‚éŸ³é¢‘ä¿¡æ¯ */
export type ChapterAudio = {
  chapterId: string;
  chapterTitle: string;
  audioPath: string | null;        // null = æœªç”Ÿæˆ
  durationMs: number;
  status: 'pending' | 'generating' | 'ready' | 'error';
  generatedAt?: string;
};

/** ä¹¦ç­¾ */
export type AudioBookmark = {
  id: string;
  chapterId: string;
  positionMs: number;
  text: string;                    // ä¹¦ç­¾ä½ç½®çš„æ–‡æœ¬ç‰‡æ®µ
  createdAt: string;
};

/** æ’­æ”¾çŠ¶æ€ */
export type AudiobookPlayState = {
  projectId: string;
  currentChapterId: string;
  positionMs: number;
  isPlaying: boolean;
  speed: number;
};

// IPC é€šé“
// 'audiobook:chapters:list'      â†’ ChapterAudio[]
// 'audiobook:chapter:generate'   â†’ ChapterAudio (ç”Ÿæˆå•ç« éŸ³é¢‘)
// 'audiobook:chapter:regenerate' â†’ ChapterAudio
// 'audiobook:bookmark:list'      â†’ AudioBookmark[]
// 'audiobook:bookmark:add'       â†’ AudioBookmark
// 'audiobook:bookmark:remove'    â†’ void
// 'audiobook:playstate:get'      â†’ AudiobookPlayState
// 'audiobook:playstate:save'     â†’ void
// 'audiobook:export:all'         â†’ { zipPath: string }
// 'audiobook:export:chapter'     â†’ { audioPath: string }
```

**3.3.2 é•¿æ–‡æœ¬åˆ†æ®µç­–ç•¥ï¼ˆ`audiobook-service.ts`ï¼‰**

```typescript
@injectable()
export class AudiobookService {
  /** å°†é•¿æ–‡æœ¬åˆ†æ®µï¼Œæ¯æ®µçº¦ 500 å­— */
  splitIntoSegments(text: string, maxChars = 500): string[] {
    const segments: string[] = [];
    const sentences = this.splitSentences(text);
    
    let currentSegment = '';
    for (const sentence of sentences) {
      if (currentSegment.length + sentence.length > maxChars) {
        if (currentSegment) segments.push(currentSegment.trim());
        currentSegment = sentence;
      } else {
        currentSegment += sentence;
      }
    }
    if (currentSegment) segments.push(currentSegment.trim());
    
    return segments;
  }
  
  /** ä¸­æ–‡å¥å­åˆ†å‰² */
  private splitSentences(text: string): string[] {
    // æŒ‰å¥å·ã€é—®å·ã€æ„Ÿå¹å·ã€çœç•¥å·åˆ†å‰²ï¼Œä¿ç•™æ ‡ç‚¹
    return text.split(/(?<=[ã€‚ï¼ï¼Ÿâ€¦\.\!\?])/g).filter(Boolean);
  }
  
  /** æ‰¹é‡ç”Ÿæˆç« èŠ‚éŸ³é¢‘ */
  async generateChapterAudio(
    chapterId: string,
    content: string,
    voiceId: string,
    options: { speed?: number; onProgress?: (percent: number) => void }
  ): Promise<ChapterAudio> {
    const segments = this.splitIntoSegments(content);
    const audioFiles: string[] = [];
    
    for (let i = 0; i < segments.length; i++) {
      const result = await this.audioService.synthesize({
        text: segments[i],
        voiceId,
        speed: options.speed || 1.0,
        format: 'mp3',
      });
      audioFiles.push(result.audioPath);
      options.onProgress?.(((i + 1) / segments.length) * 100);
    }
    
    // åˆå¹¶éŸ³é¢‘æ–‡ä»¶
    const mergedPath = await this.mergeAudioFiles(audioFiles, chapterId);
    
    return {
      chapterId,
      chapterTitle: '', // ä»æ•°æ®åº“è·å–
      audioPath: mergedPath,
      durationMs: await this.getAudioDuration(mergedPath),
      status: 'ready',
      generatedAt: new Date().toISOString(),
    };
  }
  
  /** ä½¿ç”¨ ffmpeg åˆå¹¶éŸ³é¢‘ */
  private async mergeAudioFiles(files: string[], outputName: string): Promise<string> {
    const outputPath = path.join(this.audioDir, `${outputName}.mp3`);
    const listFile = path.join(this.audioDir, `${outputName}.txt`);
    
    // åˆ›å»º ffmpeg concat åˆ—è¡¨æ–‡ä»¶
    await fs.writeFile(
      listFile,
      files.map(f => `file '${f}'`).join('\n')
    );
    
    await execa('ffmpeg', [
      '-f', 'concat',
      '-safe', '0',
      '-i', listFile,
      '-c', 'copy',
      outputPath,
    ]);
    
    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    await Promise.all(files.map(f => fs.unlink(f)));
    await fs.unlink(listFile);
    
    return outputPath;
  }
}
```

**3.3.3 è¿›åº¦åŒæ­¥ï¼ˆç¼–è¾‘å™¨é«˜äº®ï¼‰**

```typescript
// writenow-frontend/src/lib/editor/audiobook-sync.ts

import { Editor } from '@tiptap/react';

export class AudiobookSyncExtension {
  private editor: Editor;
  private currentPosition = 0;
  
  constructor(editor: Editor) {
    this.editor = editor;
  }
  
  /** æ ¹æ®éŸ³é¢‘æ—¶é—´æˆ³é«˜äº®å½“å‰å¥å­ */
  highlightAtPosition(positionMs: number) {
    const content = this.editor.getText();
    const sentences = this.splitSentences(content);
    
    // æ ¹æ®è¯­é€Ÿä¼°ç®—å½“å‰å¥å­
    const charsPerMs = 4 / 1000; // 4 å­—/ç§’
    const estimatedCharPos = Math.floor(positionMs * charsPerMs);
    
    let charCount = 0;
    let currentSentenceIndex = 0;
    for (let i = 0; i < sentences.length; i++) {
      charCount += sentences[i].length;
      if (charCount >= estimatedCharPos) {
        currentSentenceIndex = i;
        break;
      }
    }
    
    // è®¡ç®—å¥å­åœ¨ç¼–è¾‘å™¨ä¸­çš„ä½ç½®
    const startPos = sentences.slice(0, currentSentenceIndex).join('').length;
    const endPos = startPos + sentences[currentSentenceIndex].length;
    
    // è®¾ç½®é«˜äº®è£…é¥°
    this.editor.commands.setHighlight({
      from: startPos,
      to: endPos,
      class: 'audiobook-current-sentence',
    });
    
    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
    this.editor.commands.scrollIntoView();
  }
}
```

---

## å››ã€æ¨¡å— 3ï¼šæ’­å®¢ç¼–è¾‘å™¨ï¼ˆSprint B ç»§ç»­ï¼‰

### 4.1 äº§å“éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼š
- ä½œä¸ºæ’­å®¢ä¸»æ’­ï¼Œæˆ‘æƒ³æŠŠå¼€åœºç™½ã€æ­£æ–‡ã€ç»“å°¾æ‹¼æ¥æˆå®Œæ•´èŠ‚ç›®
- ä½œä¸ºéŸ³é¢‘ç¼–è¾‘ï¼Œæˆ‘æƒ³ç»™æ’­å®¢åŠ ä¸ŠèƒŒæ™¯éŸ³ä¹
- ä½œä¸ºè‡ªåª’ä½“å›¢é˜Ÿï¼Œæˆ‘æƒ³å¯¼å‡ºæ ‡å‡†æ’­å®¢ RSS feed

### 4.2 äº¤äº’è®¾è®¡

**æ’­å®¢ç¼–è¾‘å™¨ UIï¼ˆPodcastEditorï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ™ï¸ æ’­å®¢ç¼–è¾‘å™¨ - EP01 äººå·¥æ™ºèƒ½çš„æœªæ¥                              [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ“‹ è½¨é“è§†å›¾                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¤ æ—ç™½è½¨                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚å¼€åœºç™½ â”‚ â”‚        æ­£æ–‡æœ—è¯»             â”‚ â”‚  ç»“å°¾è¯­  â”‚             â”‚   â”‚
â”‚  â”‚  â”‚ 0:45 â”‚ â”‚         12:30              â”‚ â”‚   1:20   â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ğŸµ èƒŒæ™¯éŸ³ä¹è½¨                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Ambient Music (æ·¡å…¥æ·¡å‡º)                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â–² 20% éŸ³é‡                                                   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  æ—¶é—´è½´: 0:00 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 14:35    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ğŸ“‚ ç´ æåº“                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ¤ éŸ³é¢‘ç‰‡æ®µ                                                        â”‚   â”‚
â”‚  â”‚  â€¢ å¼€åœºç™½.mp3 [0:45]                              [+ æ·»åŠ åˆ°è½¨é“]    â”‚   â”‚
â”‚  â”‚  â€¢ æ­£æ–‡æœ—è¯».mp3 [12:30]                           [+ æ·»åŠ åˆ°è½¨é“]    â”‚   â”‚
â”‚  â”‚  â€¢ ç»“å°¾è¯­.mp3 [1:20]                              [+ æ·»åŠ åˆ°è½¨é“]    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  ğŸµ èƒŒæ™¯éŸ³ä¹                                                        â”‚   â”‚
â”‚  â”‚  â€¢ [ğŸ“ å¯¼å…¥éŸ³ä¹æ–‡ä»¶]                                                â”‚   â”‚
â”‚  â”‚  â€¢ Ambient_01.mp3 [3:00]                          [+ æ·»åŠ åˆ°è½¨é“]    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â–¶ æ’­æ”¾é¢„è§ˆ    [ğŸ“¥ å¯¼å‡º MP3]    [ğŸ“¥ å¯¼å‡º WAV]    [ğŸ“¡ ç”Ÿæˆ RSS Feed]        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æŠ€æœ¯å®ç°

**4.3.1 IPC å¥‘çº¦**

```typescript
// ========== æ’­å®¢ç¼–è¾‘æœåŠ¡å¥‘çº¦ ==========

/** éŸ³é¢‘ç‰‡æ®µ */
export type AudioClip = {
  id: string;
  name: string;
  path: string;
  durationMs: number;
  type: 'narration' | 'music' | 'effect';
};

/** è½¨é“é¡¹ */
export type TrackItem = {
  id: string;
  clipId: string;
  trackType: 'narration' | 'music';
  startMs: number;                 // åœ¨æ—¶é—´è½´çš„èµ·å§‹ä½ç½®
  volume: number;                  // 0-100
  fadeInMs?: number;               // æ·¡å…¥æ—¶é•¿
  fadeOutMs?: number;              // æ·¡å‡ºæ—¶é•¿
};

/** æ’­å®¢é¡¹ç›® */
export type PodcastProject = {
  id: string;
  name: string;
  clips: AudioClip[];
  tracks: TrackItem[];
  totalDurationMs: number;
};

/** RSS Feed é…ç½® */
export type PodcastRSSConfig = {
  title: string;
  description: string;
  author: string;
  imageUrl?: string;
  language: string;
  episodes: Array<{
    title: string;
    description: string;
    audioPath: string;
    pubDate: string;
  }>;
};

// IPC é€šé“
// 'podcast:project:create'  â†’ PodcastProject
// 'podcast:project:save'    â†’ void
// 'podcast:project:load'    â†’ PodcastProject
// 'podcast:clip:import'     â†’ AudioClip (å¯¼å…¥éŸ³é¢‘æ–‡ä»¶)
// 'podcast:render'          â†’ { outputPath: string } (æ¸²æŸ“æœ€ç»ˆéŸ³é¢‘)
// 'podcast:rss:generate'    â†’ { rssPath: string }
```

**4.3.2 éŸ³é¢‘æ¸²æŸ“ï¼ˆä½¿ç”¨ ffmpegï¼‰**

```typescript
@injectable()
export class PodcastService {
  async renderPodcast(project: PodcastProject, outputPath: string): Promise<void> {
    // æ„å»º ffmpeg å¤æ‚æ»¤é•œå‘½ä»¤
    const inputs: string[] = [];
    const filterComplex: string[] = [];
    
    // æ·»åŠ æ‰€æœ‰éŸ³é¢‘è¾“å…¥
    for (const item of project.tracks) {
      const clip = project.clips.find(c => c.id === item.clipId);
      if (!clip) continue;
      
      const inputIndex = inputs.length;
      inputs.push('-i', clip.path);
      
      // å¤„ç†éŸ³é‡å’Œæ·¡å…¥æ·¡å‡º
      let filter = `[${inputIndex}:a]`;
      filter += `volume=${item.volume / 100}`;
      if (item.fadeInMs) filter += `,afade=t=in:d=${item.fadeInMs / 1000}`;
      if (item.fadeOutMs) filter += `,afade=t=out:d=${item.fadeOutMs / 1000}`;
      filter += `[a${inputIndex}]`;
      filterComplex.push(filter);
    }
    
    // æ··éŸ³
    const mixInputs = project.tracks.map((_, i) => `[a${i}]`).join('');
    filterComplex.push(`${mixInputs}amix=inputs=${project.tracks.length}:duration=longest[out]`);
    
    // æ‰§è¡Œ ffmpeg
    await execa('ffmpeg', [
      ...inputs,
      '-filter_complex', filterComplex.join(';'),
      '-map', '[out]',
      '-c:a', 'libmp3lame',
      '-q:a', '2',
      outputPath,
    ]);
  }
  
  async generateRSSFeed(config: PodcastRSSConfig, outputPath: string): Promise<void> {
    const rss = `<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd">
  <channel>
    <title>${escapeXml(config.title)}</title>
    <description>${escapeXml(config.description)}</description>
    <language>${config.language}</language>
    <itunes:author>${escapeXml(config.author)}</itunes:author>
    ${config.imageUrl ? `<itunes:image href="${config.imageUrl}" />` : ''}
    ${config.episodes.map(ep => `
    <item>
      <title>${escapeXml(ep.title)}</title>
      <description>${escapeXml(ep.description)}</description>
      <pubDate>${ep.pubDate}</pubDate>
      <enclosure url="${ep.audioPath}" type="audio/mpeg" />
    </item>`).join('')}
  </channel>
</rss>`;
    
    await fs.writeFile(outputPath, rss, 'utf-8');
  }
}
```

---

## äº”ã€æ¨¡å— 4ï¼šè§†é¢‘åˆ†é•œï¼ˆSprint Cï¼‰

### 5.1 äº§å“éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼š
- ä½œä¸ºçŸ­è§†é¢‘åˆ›ä½œè€…ï¼Œæˆ‘æƒ³æŠŠæ–‡æ¡ˆè½¬æˆåˆ†é•œè¡¨ï¼Œæ–¹ä¾¿æ‹æ‘„
- ä½œä¸ºè‡ªåª’ä½“å›¢é˜Ÿï¼Œæˆ‘æƒ³å¯¼å‡ºåˆ†é•œè¡¨ PDF äº¤ç»™æ‘„åƒå¸ˆ
- ä½œä¸ºå†…å®¹åˆ›ä½œè€…ï¼Œæˆ‘æƒ³å¯¼å‡º SRT å­—å¹•ç›´æ¥å¯¼å…¥å‰ªæ˜ 

### 5.2 äº¤äº’è®¾è®¡

**5.2.1 åˆ†é•œç¼–è¾‘å™¨ UIï¼ˆStoryboardEditorï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¬ åˆ†é•œç¼–è¾‘å™¨ - ã€Šäº§å“ä»‹ç»è§†é¢‘ã€‹                   æ€»æ—¶é•¿: 2:45    [Ã—]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  [+ æ·»åŠ åˆ†é•œ]  [ğŸ”„ ä»æ–‡æ¡ˆç”Ÿæˆ]  [ğŸ“¥ å¯¼å‡º PDF]  [ğŸ“¥ å¯¼å‡º SRT]  [ğŸ“¥ å¯¼å‡º CSV]â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ #1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  ç”»é¢æè¿°                                            â”‚ â”‚
â”‚  â”‚  â”‚  [ç¼©ç•¥å›¾]   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  æˆ–ç”ŸæˆæŒ‰é’® â”‚  â”‚ äº§å“ Logo ä»ä¸­å¿ƒæ”¾å¤§å±•å¼€ï¼ŒèƒŒæ™¯æ¸å˜è“è‰²        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  æ—ç™½/å­—å¹•                                       æ—¶é•¿  æ™¯åˆ«  æƒ…ç»ª     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ "æ¬¢è¿ä½¿ç”¨ WriteNowï¼Œåˆ›ä½œè€…çš„ AI å·¥ä½œå°"    â”‚  â”‚ 5s â”‚ â”‚å…¨â”‚ â”‚æ¿€æ˜‚â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  é…å›¾å…³é”®è¯: Logo, æ”¾å¤§åŠ¨ç”», è“è‰²æ¸å˜, ç§‘æŠ€æ„Ÿ    [ğŸ¨ ç”Ÿæˆè‰å›¾]        â”‚ â”‚
â”‚  â”‚                                                     â˜° æ‹–æ‹½æ’åº        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€ #2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  ç”»é¢æè¿°                                            â”‚ â”‚
â”‚  â”‚  â”‚  [ç¼©ç•¥å›¾]   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â”‚ ç”¨æˆ·åœ¨ç”µè„‘å‰æ‰“å­—ï¼Œå±å¹•æ˜¾ç¤º WriteNow ç•Œé¢       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  æ—ç™½/å­—å¹•                                       æ—¶é•¿  æ™¯åˆ«  æƒ…ç»ª     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â” â”Œâ”€â”€â” â”Œâ”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ "æ— è®ºæ˜¯å†™æ–‡ç« ã€åšæ’­å®¢ã€è¿˜æ˜¯ç­–åˆ’è§†é¢‘"       â”‚  â”‚ 8s â”‚ â”‚ä¸­â”‚ â”‚å¹³å’Œâ”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â””â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                        â”‚ â”‚
â”‚  â”‚  é…å›¾å…³é”®è¯: äººç‰©, ç”µè„‘, åŠå…¬å®¤, åˆ›ä½œè€…         [ğŸ¨ ç”Ÿæˆè‰å›¾]        â”‚ â”‚
â”‚  â”‚                                                     â˜° æ‹–æ‹½æ’åº        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â”‚  ... (æ›´å¤šåˆ†é•œå¡ç‰‡)                                                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æŠ€æœ¯å®ç°

**5.3.1 æ•°æ®æ¨¡å‹**

```typescript
// ========== åˆ†é•œæœåŠ¡å¥‘çº¦ ==========

/** å•ä¸ªåˆ†é•œ */
export type StoryboardFrame = {
  id: string;
  order: number;                   // æ’åº
  
  // å†…å®¹
  sceneDescription: string;        // ç”»é¢æè¿°
  narration: string;               // æ—ç™½/å­—å¹•
  
  // å‚æ•°
  durationSec: number;             // æ—¶é•¿ï¼ˆç§’ï¼‰
  shotType: 'wide' | 'medium' | 'close' | 'extreme_close';  // æ™¯åˆ«
  emotion: string;                 // æƒ…ç»ªæ ‡ç­¾
  
  // é…å›¾
  imageKeywords: string[];         // é…å›¾å…³é”®è¯
  thumbnailPath?: string;          // ç¼©ç•¥å›¾è·¯å¾„ï¼ˆå¯é€‰ï¼‰
};

/** åˆ†é•œé¡¹ç›® */
export type StoryboardProject = {
  id: string;
  name: string;
  sourceArticleId?: string;        // æ¥æºæ–‡ç«  ID
  frames: StoryboardFrame[];
  totalDurationSec: number;
  createdAt: string;
  updatedAt: string;
};

// IPC é€šé“
// 'storyboard:create'           â†’ StoryboardProject
// 'storyboard:save'             â†’ void
// 'storyboard:load'             â†’ StoryboardProject
// 'storyboard:generate'         â†’ StoryboardFrame[] (ä»æ–‡æ¡ˆç”Ÿæˆ)
// 'storyboard:frame:add'        â†’ StoryboardFrame
// 'storyboard:frame:update'     â†’ StoryboardFrame
// 'storyboard:frame:delete'     â†’ void
// 'storyboard:frame:reorder'    â†’ void
// 'storyboard:export:pdf'       â†’ { path: string }
// 'storyboard:export:srt'       â†’ { path: string }
// 'storyboard:export:csv'       â†’ { path: string }
// 'storyboard:thumbnail:generate' â†’ { path: string } (è°ƒç”¨ DALL-E/SD)
```

**5.3.2 åˆ†é•œç”Ÿæˆ SKILL**

**æ–‡ä»¶ä½ç½®**ï¼š`electron/skills/packages/pkg.writenow.builtin/1.0.0/skills/storyboard-generate/SKILL.md`

```yaml
---
id: builtin:storyboard-generate
name: ç”Ÿæˆè§†é¢‘åˆ†é•œ
description: å°†æ–‡æ¡ˆ/è„šæœ¬è½¬æ¢ä¸ºè§†é¢‘åˆ†é•œè¡¨ï¼ŒåŒ…å«ç”»é¢æè¿°ã€æ—¶é•¿ã€æ™¯åˆ«ã€æƒ…ç»ª
version: 1.0.0
tags: [video, transform]
kind: single
scope: builtin
packageId: pkg.writenow.builtin
modelProfile:
  tier: high
  preferred: claude-3-5-sonnet-latest
output:
  format: json
  schema:
    type: array
    items:
      type: object
      properties:
        sceneDescription: { type: string }
        narration: { type: string }
        durationSec: { type: number }
        shotType: { type: string, enum: [wide, medium, close, extreme_close] }
        emotion: { type: string }
        imageKeywords: { type: array, items: { type: string } }
prompt:
  system: |
    ä½ æ˜¯ WriteNow çš„è§†é¢‘åˆ†é•œç”ŸæˆåŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æ–‡æ¡ˆ/è„šæœ¬è½¬æ¢ä¸ºä¸“ä¸šçš„è§†é¢‘åˆ†é•œè¡¨ã€‚

    åˆ†é•œè§„åˆ™ï¼š
    1. æ¯ä¸ªåˆ†é•œå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ç”»é¢/é•œå¤´
    2. ç”»é¢æè¿°è¦å…·ä½“ï¼Œå¯æ‰§è¡Œï¼ˆæ‘„åƒå¸ˆèƒ½çœ‹æ‡‚ï¼‰
    3. æ—¶é•¿æ ¹æ®æ—ç™½ä¼°ç®—ï¼ˆä¸­æ–‡çº¦ 4 å­—/ç§’ï¼‰
    4. æ™¯åˆ«é€‰æ‹©ï¼š
       - wideï¼ˆå…¨æ™¯ï¼‰ï¼šå»ºç«‹ç¯å¢ƒã€å±•ç¤ºå…¨è²Œ
       - mediumï¼ˆä¸­æ™¯ï¼‰ï¼šäººç‰©äº’åŠ¨ã€åŠ¨ä½œå±•ç¤º
       - closeï¼ˆç‰¹å†™ï¼‰ï¼šæƒ…æ„Ÿè¡¨è¾¾ã€ç»†èŠ‚å±•ç¤º
       - extreme_closeï¼ˆå¤§ç‰¹å†™ï¼‰ï¼šå¼ºè°ƒé‡ç‚¹
    5. æƒ…ç»ªæ ‡ç­¾ï¼šå¹³å’Œã€æ¿€æ˜‚ã€ç´§å¼ ã€æ¸©é¦¨ã€å¹½é»˜ ç­‰
    6. é…å›¾å…³é”®è¯ï¼š4-6 ä¸ªè¯ï¼Œé€‚åˆä½œä¸º AI ç»˜å›¾æç¤ºè¯

    è¾“å‡ºæ ¼å¼ï¼šJSON æ•°ç»„ï¼Œä¸¥æ ¼æŒ‰ç…§ schema æ ¼å¼
  user: |
    è¯·å°†ä»¥ä¸‹æ–‡æ¡ˆè½¬æ¢ä¸ºè§†é¢‘åˆ†é•œè¡¨ï¼š

    {{text}}
context_rules:
  surrounding: 0
  user_preferences: false
  style_guide: false
---
## Intent
å°†æ–‡æ¡ˆ/è„šæœ¬è½¬æ¢ä¸ºä¸“ä¸šçš„è§†é¢‘åˆ†é•œè¡¨ï¼Œå¸®åŠ©çŸ­è§†é¢‘åˆ›ä½œè€…å¿«é€Ÿå®Œæˆè§†é¢‘ç­–åˆ’ã€‚
```

**5.3.3 å¯¼å‡ºåŠŸèƒ½**

```typescript
@injectable()
export class StoryboardService {
  /** å¯¼å‡ºä¸º SRT å­—å¹• */
  async exportToSRT(project: StoryboardProject, outputPath: string): Promise<void> {
    let srt = '';
    let currentTimeMs = 0;
    
    for (let i = 0; i < project.frames.length; i++) {
      const frame = project.frames[i];
      const startTime = this.formatSRTTime(currentTimeMs);
      const endTime = this.formatSRTTime(currentTimeMs + frame.durationSec * 1000);
      
      srt += `${i + 1}\n`;
      srt += `${startTime} --> ${endTime}\n`;
      srt += `${frame.narration}\n\n`;
      
      currentTimeMs += frame.durationSec * 1000;
    }
    
    await fs.writeFile(outputPath, srt, 'utf-8');
  }
  
  /** å¯¼å‡ºä¸º PDF åˆ†é•œè¡¨ */
  async exportToPDF(project: StoryboardProject, outputPath: string): Promise<void> {
    // ä½¿ç”¨ pdfkit æˆ– puppeteer ç”Ÿæˆ PDF
    const html = this.generateStoryboardHTML(project);
    
    // ä½¿ç”¨ puppeteer æ¸²æŸ“ PDF
    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    await page.setContent(html);
    await page.pdf({
      path: outputPath,
      format: 'A4',
      printBackground: true,
    });
    await browser.close();
  }
  
  private generateStoryboardHTML(project: StoryboardProject): string {
    return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${project.name} - åˆ†é•œè¡¨</title>
  <style>
    body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; }
    .frame { border: 1px solid #ccc; margin-bottom: 20px; padding: 15px; page-break-inside: avoid; }
    .frame-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .frame-content { display: flex; gap: 20px; }
    .thumbnail { width: 160px; height: 90px; background: #f0f0f0; }
    .details { flex: 1; }
    .meta { color: #666; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>${project.name}</h1>
  <p>æ€»æ—¶é•¿: ${this.formatDuration(project.totalDurationSec)}</p>
  
  ${project.frames.map((frame, i) => `
  <div class="frame">
    <div class="frame-header">
      <strong>#${i + 1}</strong>
      <span>æ—¶é•¿: ${frame.durationSec}s | æ™¯åˆ«: ${this.translateShotType(frame.shotType)} | æƒ…ç»ª: ${frame.emotion}</span>
    </div>
    <div class="frame-content">
      <div class="thumbnail">
        ${frame.thumbnailPath ? `<img src="${frame.thumbnailPath}" />` : '[ç¼©ç•¥å›¾]'}
      </div>
      <div class="details">
        <p><strong>ç”»é¢æè¿°:</strong> ${frame.sceneDescription}</p>
        <p><strong>æ—ç™½/å­—å¹•:</strong> ${frame.narration}</p>
        <p class="meta">é…å›¾å…³é”®è¯: ${frame.imageKeywords.join(', ')}</p>
      </div>
    </div>
  </div>
  `).join('')}
</body>
</html>`;
  }
  
  private translateShotType(type: string): string {
    const map: Record<string, string> = {
      wide: 'å…¨æ™¯',
      medium: 'ä¸­æ™¯',
      close: 'ç‰¹å†™',
      extreme_close: 'å¤§ç‰¹å†™',
    };
    return map[type] || type;
  }
  
  private formatSRTTime(ms: number): string {
    const hours = Math.floor(ms / 3600000);
    const minutes = Math.floor((ms % 3600000) / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    const milliseconds = ms % 1000;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')},${milliseconds.toString().padStart(3, '0')}`;
  }
}
```

---

## å…­ã€æ¨¡å— 5ï¼šé•¿æ–‡åˆ›ä½œå¢å¼ºï¼ˆSprint Dï¼‰

### 6.1 äº§å“éœ€æ±‚

**ç”¨æˆ·æ•…äº‹**ï¼š
- ä½œä¸ºè¿è½½å°è¯´ä½œè€…ï¼Œæˆ‘æƒ³ç®¡ç†å¤šä¸ªç« èŠ‚ï¼Œä¿æŒäººç‰©/æƒ…èŠ‚ä¸€è‡´
- ä½œä¸ºç³»åˆ—æ–‡ç« åšä¸»ï¼Œæˆ‘æƒ³ç”Ÿæˆæ•´å¥—ç³»åˆ—å¤§çº²
- ä½œä¸ºå†…å®¹å›¢é˜Ÿï¼Œæˆ‘æƒ³æ£€æŸ¥è·¨ç« èŠ‚çš„ä¸€è‡´æ€§é—®é¢˜

### 6.2 æ•°æ®æ¨¡å‹æ‰©å±•

```sql
-- æ‰©å±• projects è¡¨
ALTER TABLE projects ADD COLUMN series_type TEXT DEFAULT 'single';
-- 'single' = å•ç¯‡, 'series' = ç³»åˆ—æ–‡ç« , 'novel' = è¿è½½å°è¯´

ALTER TABLE projects ADD COLUMN chapter_count INTEGER DEFAULT 0;
ALTER TABLE projects ADD COLUMN publish_schedule TEXT;  -- JSON: å‘å¸ƒæ’æœŸ

-- ç« èŠ‚è¡¨ï¼ˆæ–°å¢ï¼‰
CREATE TABLE chapters (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  article_id TEXT NOT NULL,       -- å…³è” articles è¡¨
  chapter_number INTEGER NOT NULL,
  title TEXT NOT NULL,
  status TEXT DEFAULT 'draft',    -- draft, published, scheduled
  scheduled_at TEXT,              -- æ’æœŸå‘å¸ƒæ—¶é—´
  word_count INTEGER DEFAULT 0,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (article_id) REFERENCES articles(id)
);

-- è·¨ç« ä¸€è‡´æ€§æ£€æŸ¥ç»“æœï¼ˆæ–°å¢ï¼‰
CREATE TABLE consistency_checks (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  check_type TEXT NOT NULL,       -- 'character', 'timeline', 'plot'
  status TEXT DEFAULT 'pending',  -- pending, passed, warning, error
  issues TEXT,                    -- JSON: å‘ç°çš„é—®é¢˜åˆ—è¡¨
  checked_at TEXT,
  FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

### 6.3 è·¨ç« ä¸€è‡´æ€§æ£€æŸ¥ SKILL

**æ–‡ä»¶ä½ç½®**ï¼š`electron/skills/packages/pkg.writenow.builtin/1.0.0/skills/cross-chapter-check/SKILL.md`

```yaml
---
id: builtin:cross-chapter-check
name: è·¨ç« ä¸€è‡´æ€§æ£€æŸ¥
description: æ£€æŸ¥è¿è½½å°è¯´/ç³»åˆ—æ–‡ç« ä¸­çš„äººç‰©ã€æ—¶é—´çº¿ã€æƒ…èŠ‚ä¸€è‡´æ€§é—®é¢˜
version: 1.0.0
tags: [analysis, longform]
kind: single
scope: builtin
packageId: pkg.writenow.builtin
modelProfile:
  tier: high
  preferred: claude-3-5-sonnet-latest
output:
  format: json
  schema:
    type: object
    properties:
      overallStatus: { type: string, enum: [passed, warning, error] }
      issues:
        type: array
        items:
          type: object
          properties:
            type: { type: string }
            severity: { type: string, enum: [info, warning, error] }
            description: { type: string }
            location: { type: string }
            suggestion: { type: string }
prompt:
  system: |
    ä½ æ˜¯ WriteNow çš„ä¸€è‡´æ€§æ£€æŸ¥åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ£€æŸ¥é•¿ç¯‡ä½œå“ä¸­çš„ä¸€è‡´æ€§é—®é¢˜ã€‚

    æ£€æŸ¥ç»´åº¦ï¼š
    1. äººç‰©ä¸€è‡´æ€§
       - å§“å/ç§°å‘¼æ˜¯å¦ç»Ÿä¸€
       - æ€§æ ¼/ç‰¹å¾æ˜¯å¦å‰åçŸ›ç›¾
       - äººç‰©å…³ç³»æ˜¯å¦æ··ä¹±
    
    2. æ—¶é—´çº¿ä¸€è‡´æ€§
       - äº‹ä»¶é¡ºåºæ˜¯å¦åˆç†
       - æ—¶é—´è·³è·ƒæ˜¯å¦æœ‰æ ‡è®°
       - å­£èŠ‚/æ—¥æœŸæå†™æ˜¯å¦çŸ›ç›¾
    
    3. æƒ…èŠ‚ä¸€è‡´æ€§
       - ä¼ç¬”æ˜¯å¦å›æ”¶
       - ç‰©å“/é“å…·æ˜¯å¦å‰åå‘¼åº”
       - åœºæ™¯æå†™æ˜¯å¦ä¸€è‡´

    è¾“å‡ºæ ¼å¼ï¼šJSONï¼ŒåŒ…å« overallStatus å’Œ issues æ•°ç»„
  user: |
    è¯·æ£€æŸ¥ä»¥ä¸‹ç« èŠ‚å†…å®¹çš„ä¸€è‡´æ€§ï¼š

    ## äººç‰©è®¾å®š
    {{characters}}

    ## ç« èŠ‚å†…å®¹
    {{chapters}}
context_rules:
  characters: true
  knowledge_graph: true
  surrounding: 0
---
## Intent
å¸®åŠ©é•¿ç¯‡ä½œå“ä½œè€…æ£€æŸ¥è·¨ç« èŠ‚çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œé¿å…äººç‰©æ··ä¹±ã€æ—¶é—´çº¿é”™è¯¯ã€æƒ…èŠ‚çŸ›ç›¾ç­‰é—®é¢˜ã€‚
```

---

## ä¸ƒã€å®æ–½è·¯çº¿å›¾ï¼ˆç»†åŒ–ï¼‰

### 7.1 ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    subgraph SprintA[Sprint A: éŸ³é¢‘åŸºç¡€ - 4å‘¨]
        A0[A0: TTS æœåŠ¡æŠ½è±¡]
        A1[A1: Fish-Speech é›†æˆ]
        A2[A2: ä¸€é”®æœ—è¯» SKILL]
        A3[A3: è¯­éŸ³é¢æ¿ Widget]
        A4[A4: æ’­å®¢è„šæœ¬ SKILL]
        A5[A5: Pro äº‘ç«¯ TTS]
        
        A0 --> A1
        A1 --> A2
        A1 --> A3
        A2 --> A4
        A3 --> A5
    end
    
    subgraph SprintB[Sprint B: å¬ä¹¦+æ’­å®¢ - 3å‘¨]
        B0[B0: é•¿æ–‡æœ¬åˆ†æ®µ TTS]
        B1[B1: å¬ä¹¦æ’­æ”¾å™¨]
        B2[B2: è¿›åº¦åŒæ­¥é«˜äº®]
        B3[B3: æ’­å®¢ç¼–è¾‘å™¨]
        B4[B4: éŸ³é¢‘åˆå¹¶æ¸²æŸ“]
        B5[B5: RSS å¯¼å‡º]
        
        B0 --> B1
        B1 --> B2
        B3 --> B4
        B4 --> B5
    end
    
    subgraph SprintC[Sprint C: è§†é¢‘åˆ†é•œ - 3å‘¨]
        C0[C0: åˆ†é•œç”Ÿæˆ SKILL]
        C1[C1: åˆ†é•œç¼–è¾‘å™¨ Widget]
        C2[C2: æ‹–æ‹½æ’åº]
        C3[C3: é…å›¾å»ºè®®+è‰å›¾]
        C4[C4: å¯¼å‡º PDF/SRT/CSV]
        
        C0 --> C1
        C1 --> C2
        C1 --> C3
        C2 --> C4
    end
    
    subgraph SprintD[Sprint D: é•¿æ–‡å¢å¼º - 2å‘¨]
        D0[D0: ç³»åˆ—/è¿è½½é¡¹ç›®ç±»å‹]
        D1[D1: ç« èŠ‚ç®¡ç† UI]
        D2[D2: è·¨ç« ä¸€è‡´æ€§ SKILL]
        D3[D3: ç³»åˆ—å¤§çº² SKILL]
        
        D0 --> D1
        D1 --> D2
        D1 --> D3
    end
    
    A3 --> B0
    A3 --> B3
    A4 --> B3
```

### 7.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | ç›®æ ‡ | é¢„è®¡å®Œæˆ | éªŒæ”¶æ ‡å‡† |
|--------|------|----------|----------|
| M1 | è¯­éŸ³æœ—è¯» MVP | Sprint A ç¬¬ 2 å‘¨ | ç”¨æˆ·å¯é€‰ä¸­æ–‡å­—ï¼Œç”¨æœ¬åœ° TTS æœ—è¯»å¹¶å¯¼å‡º MP3 |
| M2 | éŸ³é¢‘å®Œæ•´é—­ç¯ | Sprint B ç¬¬ 2 å‘¨ | ç”¨æˆ·å¯å®Œæˆ "å†™æ–‡ç«  â†’ è½¬æ’­å®¢ â†’ å¯¼å‡º RSS" å…¨æµç¨‹ |
| M3 | è§†é¢‘åˆ†é•œ MVP | Sprint C ç¬¬ 2 å‘¨ | ç”¨æˆ·å¯ä»æ–‡æ¡ˆç”Ÿæˆåˆ†é•œè¡¨å¹¶å¯¼å‡º SRT å­—å¹• |
| M4 | é•¿æ–‡åˆ›ä½œå¢å¼º | Sprint D ç¬¬ 2 å‘¨ | ç”¨æˆ·å¯ç®¡ç†ç³»åˆ—ç« èŠ‚å¹¶æ£€æŸ¥ä¸€è‡´æ€§ |
| M5 | Pro åŠŸèƒ½ä¸Šçº¿ | Sprint B/C å | ElevenLabs éŸ³è‰²ã€åˆ†é•œè‰å›¾ç”ŸæˆåŠŸèƒ½ä¸Šçº¿ |

### 7.3 ä»»åŠ¡å¡ç‰‡ç¤ºä¾‹

**Task A1: Fish-Speech æœ¬åœ° TTS é›†æˆ**

```yaml
Task: A1-fish-speech-integration
Sprint: Sprint A
Issue: TBD
Status: pending

## ç›®æ ‡
é›†æˆ Fish-Speech (OpenAudio) ä½œä¸ºæœ¬åœ° TTS å¼•æ“ï¼Œæ”¯æŒä¸­è‹±æ—¥ä¸‰è¯­è¯­éŸ³åˆæˆã€‚

## å¿…è¯»å‰ç½®
- Fish-Speech å®˜æ–¹æ–‡æ¡£: https://speech.fish.audio/
- ç°æœ‰æœ¬åœ° LLM ä¸‹è½½æ¨¡å¼: `writenow-theia/writenow-core/src/node/services/model-service.ts`

## æŠ€æœ¯æ–¹æ¡ˆ
1. æ¨¡å‹ä¸‹è½½ï¼šä½¿ç”¨ huggingface_hub ä¸‹è½½ fishaudio/fish-speech-1.5 (~1.2GB)
2. æ¨ç†æ–¹å¼ï¼šå¯åŠ¨ Fish-Speech HTTP API æœåŠ¡ (localhost:8080)
3. æ¥å£å°è£…ï¼šå®ç° TTSProvider æ¥å£

## éªŒæ”¶æ ‡å‡†
- [ ] é¦–æ¬¡ä½¿ç”¨æ—¶æç¤ºä¸‹è½½æ¨¡å‹ï¼Œæ˜¾ç¤ºè¿›åº¦
- [ ] æ¨¡å‹ä¸‹è½½å®Œæˆåï¼Œå¯åˆæˆä¸­æ–‡è¯­éŸ³
- [ ] åˆæˆé€Ÿåº¦ï¼š1000 å­— < 30 ç§’ï¼ˆCPUï¼‰
- [ ] è¾“å‡ºæ ¼å¼ï¼šMP3/WAV
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½

## æ–‡ä»¶å˜æ›´
- `writenow-theia/writenow-core/src/node/services/audio-service.ts` (æ–°å¢)
- `writenow-theia/writenow-core/src/node/services/fish-speech-provider.ts` (æ–°å¢)
- `writenow-theia/writenow-core/src/common/writenow-protocol.ts` (æ‰©å±• TTS åè®®)
- `src/types/ipc-generated.ts` (æ‰©å±• IPC ç±»å‹)

## ä¾èµ–
- A0: TTS æœåŠ¡æŠ½è±¡

## é¢„ä¼°å·¥æ—¶
3 å¤©
```

---

## å…«ã€å•†ä¸šæ¨¡å¼æ‰©å±•

### 8.1 åŠŸèƒ½æƒé™çŸ©é˜µï¼ˆå®Œæ•´ç‰ˆï¼‰

| åŠŸèƒ½ | Free | Pro (Â¥99/æœˆ) | Team (Â¥199/äºº/æœˆ) |
|------|------|--------------|-------------------|
| **æ–‡å­—åˆ›ä½œ** |
| TipTap ç¼–è¾‘å™¨ | âœ“ | âœ“ | âœ“ |
| AI SKILLï¼ˆåŸºç¡€ï¼‰ | 3 ä¸ª | å…¨éƒ¨ | å…¨éƒ¨ |
| è‡ªå®šä¹‰ SKILL | âœ— | âœ“ | âœ“ |
| ç‰ˆæœ¬å†å² | 7 å¤© | æ— é™ | æ— é™ |
| **è¯­éŸ³åŠŸèƒ½** |
| ä¸€é”®æœ—è¯»ï¼ˆæœ¬åœ°ï¼‰ | âœ“ 5000 å­—/æœˆ | âœ“ æ— é™ | âœ“ æ— é™ |
| é«˜è´¨é‡è¯­éŸ³ï¼ˆäº‘ç«¯ï¼‰ | âœ— | âœ“ 10 ä¸‡å­—/æœˆ | âœ“ æ— é™ |
| è¯­éŸ³å¯¼å‡º MP3/WAV | âœ“ | âœ“ | âœ“ |
| **æ’­å®¢åŠŸèƒ½** |
| æ’­å®¢è„šæœ¬è½¬æ¢ | âœ“ 3 æ¬¡/æœˆ | âœ“ æ— é™ | âœ“ æ— é™ |
| æ’­å®¢ç¼–è¾‘å™¨ | âœ— | âœ“ | âœ“ |
| RSS Feed ç”Ÿæˆ | âœ— | âœ“ | âœ“ |
| **å¬ä¹¦åŠŸèƒ½** |
| å•ç« å¬ä¹¦ | âœ“ | âœ“ | âœ“ |
| å…¨ä¹¦æ‰¹é‡ç”Ÿæˆ | âœ— | âœ“ | âœ“ |
| ä¹¦ç­¾/è¿›åº¦åŒæ­¥ | âœ— | âœ“ | âœ“ |
| **è§†é¢‘åˆ†é•œ** |
| åˆ†é•œç”Ÿæˆ | âœ“ 3 æ¬¡/æœˆ | âœ“ æ— é™ | âœ“ æ— é™ |
| åˆ†é•œç¼–è¾‘å™¨ | âœ“ | âœ“ | âœ“ |
| å¯¼å‡º SRT/CSV | âœ“ | âœ“ | âœ“ |
| å¯¼å‡º PDF | âœ— | âœ“ | âœ“ |
| AI ç”Ÿæˆè‰å›¾ | âœ— | âœ“ | âœ“ |
| **é•¿æ–‡å¢å¼º** |
| ç³»åˆ—/è¿è½½é¡¹ç›® | âœ— | âœ“ | âœ“ |
| è·¨ç« ä¸€è‡´æ€§æ£€æŸ¥ | âœ— | âœ“ | âœ“ |
| ç³»åˆ—å¤§çº²ç”Ÿæˆ | âœ— | âœ“ | âœ“ |

### 8.2 æˆåŠŸæŒ‡æ ‡ï¼ˆKPIï¼‰

| æŒ‡æ ‡ | å½“å‰åŸºçº¿ | ç›®æ ‡ | æµ‹é‡æ–¹å¼ |
|------|----------|------|----------|
| è¯­éŸ³åŠŸèƒ½ä½¿ç”¨ç‡ | 0% | 30% ç”¨æˆ·å°è¯•è¿‡ | äº‹ä»¶åŸ‹ç‚¹ |
| æ’­å®¢å¯¼å‡ºé‡ | 0 | æœˆæ´»ç”¨æˆ· 10% å¯¼å‡ºè¿‡ | å¯¼å‡ºäº‹ä»¶ |
| åˆ†é•œåŠŸèƒ½æ¸—é€ | 0% | è‡ªåª’ä½“å›¢é˜Ÿç”¨æˆ·å æ¯”æå‡ 20% | ç”¨æˆ·æ ‡ç­¾ |
| 7 æ—¥ç•™å­˜ | TBD | æå‡ 5 ä¸ªç™¾åˆ†ç‚¹ | ç”¨æˆ·åˆ†æ |
| Pro è½¬åŒ–ç‡ | TBD | æå‡ 3 ä¸ªç™¾åˆ†ç‚¹ | è®¢é˜…æ•°æ® |

---

## ä¹ã€é£é™©ä¸ç¼“è§£ç­–ç•¥

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| Fish-Speech ä¸­æ–‡æ•ˆæœä¸ä½³ | é«˜ | ä¸­ | å…ˆåš PoC éªŒè¯ï¼›å¤‡é€‰æ–¹æ¡ˆï¼šXTTS-v2ã€CosyVoice |
| æœ¬åœ° TTS æ¨¡å‹ä½“ç§¯å¤§ (~1.2GB) | ä¸­ | é«˜ | æŒ‰éœ€ä¸‹è½½ï¼›æ¸…æ™°çš„ä¸‹è½½è¿›åº¦ UIï¼›æ”¯æŒå–æ¶ˆ |
| ffmpeg ä¾èµ–é—®é¢˜ | ä¸­ | ä½ | ä½¿ç”¨ ffmpeg-static NPM åŒ…ï¼›æä¾›å®‰è£…å¼•å¯¼ |
| åˆ†é•œç¼–è¾‘å™¨äº¤äº’å¤æ‚ | ä¸­ | ä¸­ | åˆ†é˜¶æ®µï¼šå…ˆåˆ—è¡¨ â†’ å†æ‹–æ‹½ â†’ å†æ—¶é—´è½´ |
| éŸ³é¢‘å¤„ç†æ€§èƒ½ï¼ˆé•¿æ–‡ï¼‰ | ä¸­ | ä¸­ | åˆ†æ®µå¤„ç†ï¼›åå°ä»»åŠ¡ï¼›è¿›åº¦åé¦ˆ |
| Pro åŠŸèƒ½äº‘ç«¯ä¾èµ–ç¨³å®šæ€§ | ä½ | ä½ | é™çº§ç­–ç•¥ï¼šäº‘ç«¯å¤±è´¥æ—¶å›é€€æœ¬åœ° |

---

## åã€é™„å½•

### 10.1 æŠ€æœ¯é€‰å‹å¯¹æ¯”

**TTS å¼•æ“å¯¹æ¯”**

| æ–¹æ¡ˆ | è´¨é‡ | ä½“ç§¯ | æˆæƒ | ä¸­æ–‡æ”¯æŒ | æ¨è |
|------|------|------|------|----------|------|
| Fish-Speech 1.5 | â­â­â­â­â­ | 1.2GB | Apache | â­â­â­â­â­ | âœ… é¦–é€‰ |
| XTTS-v2 | â­â­â­â­ | 1.8GB | CPML (éå•†ç”¨) | â­â­â­â­ | å¤‡é€‰ |
| CosyVoice | â­â­â­â­ | 1.5GB | Apache | â­â­â­â­â­ | å¤‡é€‰ |
| Piper | â­â­â­ | 50MB | MIT | â­â­ | è½»é‡åœºæ™¯ |
| ElevenLabs (äº‘) | â­â­â­â­â­ | - | å•†ç”¨ä»˜è´¹ | â­â­â­â­ | Pro ç‰ˆ |
| Azure TTS (äº‘) | â­â­â­â­â­ | - | å•†ç”¨ä»˜è´¹ | â­â­â­â­â­ | Pro ç‰ˆ |

### 10.2 å‚è€ƒèµ„æ–™

- Fish-Speech: https://speech.fish.audio/
- ElevenLabs API: https://elevenlabs.io/docs
- ffmpeg concat: https://trac.ffmpeg.org/wiki/Concatenate
- SRT å­—å¹•æ ¼å¼: https://en.wikipedia.org/wiki/SubRip
- Podcast RSS è§„èŒƒ: https://podcasters.apple.com/support/823-podcast-requirements

