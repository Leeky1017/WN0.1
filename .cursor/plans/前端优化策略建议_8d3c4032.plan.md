---
name: 前端优化策略建议
overview: 基于当前两个商业化基石 Plan 的优先级（AI Memory + Open Source Optimization）和前端现状评估，给出前端优化的策略建议：不单独建立 Plan，而是分层处理。
todos: []
isProject: false
---

# 前端优化策略建议

## 结论

**不建议现在单独制定前端优化 Plan**，原因：

1. **当前前端质量良好**：类型安全、状态管理规范、性能优化到位
2. **商业化优先**：AI Memory + Open Source Optimization 是营收基石，应集中资源
3. **问题可分层解决**：按以下策略逐步消化

---

## 分层策略

### Layer 1：随手修复（与当前 Plan 并行，不阻塞）

P0 问题可在日常开发中顺手修复（估计 2-4 小时）：

- 硬编码 WebSocket URL → 提取为环境变量 `VITE_RPC_URL`
  - [`src/lib/hooks/useRpcConnection.ts:8`](writenow-frontend/src/lib/hooks/useRpcConnection.ts)
  - [`src/lib/rpc/skills-client.ts:10`](writenow-frontend/src/lib/rpc/skills-client.ts)
  - [`src/lib/rpc/ai-client.ts:19`](writenow-frontend/src/lib/rpc/ai-client.ts)
- `window.prompt` → 替换为 shadcn/ui Dialog

### Layer 2：合并到现有 Plan

以下任务可合并到 **WN Open Source Optimization** Plan：

| 已有任务 | 可追加的前端工作 |

|---------|-----------------|

| P1: TipTap AI Diff Extension | 同时优化 TipTap 导入（避免 StarterKit 重复） |

| P2: E2E Playwright 测试 | 补充前端组件/hooks 测试 |

### Layer 3：后续独立 Sprint（商业化基石完成后）

完成 AI Memory + Open Source Optimization 后，可规划 **Sprint Frontend Polish**：

**Phase 1：代码质量（3-5 天）**

- 统一日志系统（替换 20 处 `console.*`）
- 移除未使用依赖：`react-hotkeys-hook`, `sonner`, `cmdk`, 部分 Radix UI
- 拆分大组件：`AppShell.tsx`, `AIPanel.tsx`
- 移除硬编码演示数据

**Phase 2：构建优化（2-3 天）**

- Vite 配置优化（分包、压缩、drop_console）
- 添加 Bundle 分析工具（rollup-plugin-visualizer）
- 添加 Prettier 配置文件

**Phase 3：测试覆盖（5-7 天）**

- 关键 hooks 单元测试（`useAISkill`, `useFileTree`, `useSettings`）
- Zustand stores 状态转换测试
- 核心用户流程 E2E 测试

---

## 时间线建议

```
现在 ─────────────────────────────────────────────────────────────────────>
      │                                                   │
      ├── 商业化基石 ─────────────────────────────────────┤
      │   ├── AI Memory Research 落地                     │
      │   └── WN Open Source Optimization                 │
      │       ├── P0: Prompt Caching                      │
      │       ├── P1: Mem0 / TipTap AI Diff / Tab 续写    │
      │       └── P2: E2E 测试                            │
      │                                                   │
      ├── 随手修复（Layer 1）──────────────────────────────┤
      │   └── 硬编码 URL / window.prompt                  │
      │                                                   │
      └── 商业化基石完成后 ──────────────────── Sprint Frontend Polish
                                                ├── Phase 1: 代码质量
                                                ├── Phase 2: 构建优化
                                                └── Phase 3: 测试覆盖
```

---

## 下一步行动

1. **立即**：在当前开发中顺手修复 P0 问题（硬编码 URL、window.prompt）
2. **继续**：推进 AI Memory + Open Source Optimization
3. **记录**：将 Layer 3 的内容作为「待排期」任务卡片存入 OpenSpec
4. **时机**：当商业化基石 P0/P1 完成后，评估是否启动 Sprint Frontend Polish

---

## 附录：探索发现详情

### 未使用的依赖（建议移除）

- `react-hotkeys-hook` (^5.2.3)
- `sonner` (^2.0.7)
- `cmdk` (^1.1.1)
- `@radix-ui/react-dialog` (^1.1.15)
- `@radix-ui/react-dropdown-menu` (^2.1.16)
- `@radix-ui/react-slider` (^1.3.6)
- `@radix-ui/react-switch` (^1.2.6)

### Vite 构建优化配置示例

```typescript
// vite.config.ts 优化建议
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'react-vendor': ['react', 'react-dom'],
        'tiptap-vendor': ['@tiptap/core', '@tiptap/react', '@tiptap/starter-kit'],
        'framer-motion': ['framer-motion'],
      },
    },
  },
  minify: 'terser',
  terserOptions: { compress: { drop_console: true } },
}
```

### 测试覆盖现状

- 现有：3 个测试文件（`components.test.tsx`, `composed.test.tsx`, `theme.test.ts`）
- 缺失：hooks 测试、stores 测试、E2E 测试

---

## 附录 B：样式与 UI/UX 优化方向调研

> 此部分为后续 Sprint Frontend Polish 的参考，防止遗忘。

### B1. 当前样式系统评估

#### 已有优势（保持）

| 维度 | 当前实现 | 评价 |

|------|---------|------|

| Design Tokens | 分层清晰（primitives → semantic → components） | 优秀 |

| 主题系统 | dark/light/midnight/system + 持久化 + 系统监听 | 优秀 |

| Style Guard | 禁止硬编码颜色，CI 自动检查 | 优秀 |

| 组件一致性 | 统一使用设计系统变量 | 良好 |

| 性能优化 | GPU 加速、will-change、memo | 良好 |

#### 已有问题（待改进）

| 优先级 | 问题 | 位置 | 改进建议 |

|--------|------|------|---------|

| P0 | TipTap 编辑器内容样式缺失（标题/列表/引用等无样式） | `globals.css` | 添加 ProseMirror 内容样式 |

| P0 | 浮动工具栏使用未定义变量 `--bg-panel` | `FloatingToolbar.tsx` | 改用 `--bg-elevated` |

| P1 | 命令面板 UI 未实现（cmdk 仅安装未使用） | - | 实现 Command 组件 |

| P1 | 设置面板仅占位文本 | `SettingsPanel.tsx` | 实现完整设置界面 |

| P1 | 响应式适配不足（固定宽度面板） | `AppShell.tsx` | 添加响应式断点 |

| P2 | framer-motion 使用不统一（部分用 CSS，部分用 JS） | 多处 | 统一动画方案 |

| P2 | 文件树展开/折叠无动画 | `FileItem.tsx` | 添加 motion 动画 |

| P2 | `midnight` 与 `dark` 主题差异不明确 | tokens | 明确设计意图或合并 |

| P3 | 缺少设计系统文档站点（Storybook 等） | - | 可选 |

### B2. TipTap 编辑器样式改进（P0）

当前编辑器容器有样式，但 ProseMirror 内容（标题、列表、引用等）无样式定义。

**建议添加到 `globals.css`**：

```css
/* TipTap 编辑器内容样式 */
.wn-tiptap-editor .ProseMirror {
  outline: none;
}

.wn-tiptap-editor h1 {
  font-size: 2em;
  font-weight: 700;
  margin: 1.5em 0 0.5em;
  line-height: 1.2;
}

.wn-tiptap-editor h2 {
  font-size: 1.5em;
  font-weight: 600;
  margin: 1.25em 0 0.5em;
}

.wn-tiptap-editor h3 {
  font-size: 1.25em;
  font-weight: 600;
  margin: 1em 0 0.5em;
}

.wn-tiptap-editor p {
  margin: 0.75em 0;
}

.wn-tiptap-editor ul,
.wn-tiptap-editor ol {
  padding-left: 1.5em;
  margin: 0.5em 0;
}

.wn-tiptap-editor blockquote {
  border-left: 3px solid var(--border-default);
  padding-left: 1em;
  margin: 1em 0;
  color: var(--fg-muted);
  font-style: italic;
}

.wn-tiptap-editor code {
  background: var(--bg-input);
  padding: 0.1em 0.3em;
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 0.9em;
}

.wn-tiptap-editor pre {
  background: var(--bg-surface);
  padding: 1em;
  border-radius: var(--radius-md);
  overflow-x: auto;
}

.wn-tiptap-editor hr {
  border: none;
  border-top: 1px solid var(--border-subtle);
  margin: 2em 0;
}

/* 光标样式 */
.wn-tiptap-editor .ProseMirror-focused {
  caret-color: var(--accent-default);
}

/* 选区样式 */
.wn-tiptap-editor ::selection {
  background: var(--accent-muted);
  color: var(--fg-default);
}
```

### B3. 布局系统改进

#### 当前布局结构

```
┌─────────────────────────────────────────────────────────────┐
│ ActivityBar (48px) │ SidebarPanel (260px) │ Editor │ AIPanel (360px) │
└─────────────────────────────────────────────────────────────┘
```

**问题**：固定宽度，小屏幕体验差

**改进方案**：

1. **响应式断点**：

   - `< 768px`：侧边栏全屏覆盖模式
   - `768px - 1280px`：侧边栏可折叠，AI 面板默认隐藏
   - `> 1280px`：当前三栏布局

2. **可调整宽度**（可选）：

   - 引入 resize handle
   - 设置 min/max 约束（Sidebar: 180-500px, AI Panel: 280-600px）

3. **移动端适配**（可选，低优先级）：

   - 底部导航栏替代侧边栏
   - AI 面板作为全屏 Sheet

### B4. 动效统一方案

#### 当前问题

- framer-motion 使用不一致（有的组件用，有的不用）
- 缺少统一的动画预设

#### 建议方案

**创建动画预设文件 `src/lib/motion/presets.ts`**：

```typescript
export const fadeIn = {
  initial: { opacity: 0 },
  animate: { opacity: 1 },
  exit: { opacity: 0 },
  transition: { duration: 0.15 },
}

export const slideUp = {
  initial: { opacity: 0, y: 8 },
  animate: { opacity: 1, y: 0 },
  exit: { opacity: 0, y: 8 },
  transition: { duration: 0.15 },
}

export const slideRight = {
  initial: { opacity: 0, x: -8 },
  animate: { opacity: 1, x: 0 },
  exit: { opacity: 0, x: -8 },
  transition: { duration: 0.15 },
}

export const scaleIn = {
  initial: { opacity: 0, scale: 0.95 },
  animate: { opacity: 1, scale: 1 },
  exit: { opacity: 0, scale: 0.95 },
  transition: { duration: 0.1 },
}

// 列表项 stagger
export const staggerContainer = {
  animate: { transition: { staggerChildren: 0.05 } },
}

export const staggerItem = {
  initial: { opacity: 0, y: 4 },
  animate: { opacity: 1, y: 0 },
}
```

**使用示例**：

```tsx
import { motion } from 'framer-motion'
import { fadeIn, staggerContainer, staggerItem } from '@/lib/motion/presets'

// 单个元素
<motion.div {...fadeIn}>Content</motion.div>

// 列表
<motion.ul {...staggerContainer}>
  {items.map(item => (
    <motion.li key={item.id} {...staggerItem}>{item.name}</motion.li>
  ))}
</motion.ul>
```

### B5. 业界参考（Cursor / Notion / Arc）

| 产品 | 值得借鉴的 UI 设计 | WriteNow 可应用场景 |

|------|-------------------|-------------------|

| **Cursor** | 视觉编辑器（点击元素 → 描述修改） | AI 面板的"指向修改"交互 |

| **Cursor** | 多行编辑建议 inline 预览 | Tab 续写的灰色预览 |

| **Notion AI** | 上下文式 AI 集成（一键 Improve writing） | SKILL 快捷按钮 |

| **Notion AI** | AI 出现在已有 block 系统中 | AI 建议作为编辑器 block |

| **Arc** | 艺术化背景（painted landscape） | 可选的沉浸式写作背景 |

| **Arc** | Space 概念（项目隔离） | 项目切换的视觉隔离 |

### B6. Sprint Frontend Polish 完整规划

> 商业化基石完成后执行

**Phase 1：代码质量（3-5 天）** [已有]

**Phase 2：构建优化（2-3 天）** [已有]

**Phase 3：测试覆盖（5-7 天）** [已有]

**Phase 4：编辑器样式（2-3 天）** [新增]

- 添加 TipTap 内容样式（标题/列表/引用/代码等）
- 光标和选区样式定制
- AI Diff 视觉呈现（绿色新增/红色删除）
- Tab 续写灰色预览样式

**Phase 5：核心组件补全（3-5 天）** [新增]

- 实现命令面板 UI（cmdk）
- 实现设置面板（主题/字体/偏好）
- 浮动工具栏边界检测和动画
- 文件树展开/折叠动画

**Phase 6：响应式与动效（3-5 天）** [新增]

- 响应式断点适配（768px / 1280px）
- 统一 framer-motion 动画预设
- 列表 stagger 动画
- 页面过渡动画

**Phase 7：设计系统完善（2-3 天）** [可选]

- 明确 midnight vs dark 差异
- 实现 high-contrast 主题
- 考虑 Storybook 组件文档

### B7. 优先级总结

| 优先级 | 任务 | 预估工时 | 影响 |

|--------|------|---------|------|

| **P0** | TipTap 内容样式 | 1 天 | 基础体验 |

| **P0** | 修复 `--bg-panel` 变量 | 0.5 小时 | 主题一致性 |

| **P1** | 命令面板 UI | 1-2 天 | 核心交互 |

| **P1** | 设置面板 | 1-2 天 | 核心交互 |

| **P1** | 响应式适配 | 2-3 天 | 多设备支持 |

| **P2** | 统一动画预设 | 1 天 | 体验一致性 |

| **P2** | 文件树动画 | 0.5 天 | 细节体验 |

| **P3** | midnight/dark 差异化 | 0.5 天 | 可选 |

| **P3** | high-contrast 主题 | 1 天 | 可访问性 |

---

**本 Plan 更新于**：2026-01-27

**状态**：调研完成，待排期（商业化基石完成后）