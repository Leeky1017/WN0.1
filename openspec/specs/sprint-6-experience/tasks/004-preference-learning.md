# 任务 004: 用户偏好学习（Preference Learning）

## 目标

实现用户偏好学习的可控闭环：系统从用户行为中提取“偏好信号”（例如采纳/拒绝 AI 改写、对措辞的重复修改），并以可审阅/可撤销的方式更新到外挂记忆（`user_memory`），用于后续 AI 调用的风格对齐。默认行为需可关闭，且在隐私模式下遵循最小化策略。

## 依赖

- 任务 003：外挂记忆系统（用于存储与管理偏好）
- Sprint 2 AI 能力（或等价 Diff/接受/拒绝通路）：用于产生偏好信号
- （建议）设置系统：用于开关与策略配置（可先落在 `settings` 表）

## 实现步骤

1. 定义“偏好信号”与审计策略：
   - 信号来源：接受/拒绝/部分接受、撤销/回退、重复替换某类措辞等
   - 审计要求：至少记录事件时间、来源（skill/场景）、简短摘要（避免保存敏感全文）
2. 信号收集：
   - 在“接受/拒绝 AI 结果”的动作处记录信号（Sprint 6 可先覆盖此核心路径）
   - 为未来扩展预留：从编辑器的“重复改写模式”提取信号（可后续）
3. 偏好提取与合并：
   - 采用阈值策略：同类信号累计达到 N 次才生成/更新偏好（避免一次性过拟合）
   - 将偏好写入 `user_memory`（type=`preference`），内容为可读的偏好语句（例如“偏好更简洁的表达，减少形容词堆叠”）
4. 用户可控（必须）：
   - 设置开关：启用/禁用偏好学习
   - 审阅入口：查看最近学习到的偏好/来源摘要
   - 支持撤销：删除某条偏好，或一键清空学习产物
5. AI 注入联动：
   - 确保 AI 请求构建阶段优先注入 `preference` 类型记忆
   - 隐私模式下：仅注入用户明确保留的偏好（或完全不注入，按策略明确）

## 新增/修改文件

- `src/stores/preferenceLearningStore.ts`（或 `memoryStore` 内）- 学习开关/信号队列/合并策略（新增/修改）
- `electron/ipc/memory.cjs` - 写入/更新 `user_memory` 的合并接口（修改）
- `src/components/sidebar-views/MemoryView.tsx` / `SettingsView.tsx` - 偏好学习开关与审阅 UI（修改）
- `src/stores/aiStore.ts` / AI 交互组件 - 在接受/拒绝动作处上报信号（修改）

## 验收标准

- [ ] 用户可在设置中关闭偏好学习，关闭后不再产生新偏好
- [ ] 经过多次接受/拒绝后，会生成或更新至少 1 条可读的偏好记忆
- [ ] 用户可查看偏好变更，并可撤销/删除任意一条偏好
- [ ] 隐私模式下遵循最小化策略（不隐式学习或不自动注入）

## 参考

- Sprint 6 规范：`openspec/specs/sprint-6-experience/spec.md`
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 288-294 行（记忆更新：显式/隐式）
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 829-837 行（`user_memory` 表）
