# 任务 004: 基础 RAG 检索逻辑

## 目标

实现可复用的基础 RAG 检索管线：基于用户选区/指令，结合 FTS5 全文召回 + sqlite-vec 语义召回，生成结构化上下文包（含引用证据），用于注入到 Sprint 2 的 AI SKILL 调用中。

## 依赖

- 任务 001：Embedding 模型（生成向量）
- 任务 002：FTS5 全文索引（keyword 召回）
- 任务 003：sqlite-vec 向量存储（语义召回）

## 实现步骤

1. 定义检索粒度与分块策略：
   - 段落级分块（默认）并保留章节/标题/路径等结构信息
   - 维护 chunk 的稳定标识（用于更新/去重）
2. 建立索引更新流水线：
   - 文档保存后触发：更新 FTS + 重分块 + 生成 embedding + 写入向量表
   - 支持增量更新（避免每次全量重建）
3. 实现检索策略（最小闭环）：
   - 语义召回：对选区生成 embedding，向量 topK 查询
   - 关键词召回：对选区关键词/实体名做 FTS5 查询
   - 融合排序：合并去重并按分数/时间/章节邻近等规则排序
4. 生成结构化上下文包：
   - 包含：人物/设定卡片（若可得）、相关段落列表、来源引用（文档/章节/位置）
   - 支持预算控制（最大条目数/最大字符数），并在超限时做裁剪
5. 与 AI 调用对接（接口级即可）：
   - 在主进程 AI 代理中加入 `context` 参数（可选）
   - 记录检索证据（用于一致性检查与调试）

## 新增/修改文件

- `electron/lib/rag/retrieval.cjs` - 检索管线与融合排序（新增）
- `electron/ipc/rag.cjs` - RAG 检索 IPC（新增）
- `electron/main.cjs` - 注册 IPC / AI 调用注入点（修改）
- `openspec/specs/sprint-3-rag/spec.md` - 验收口径（参考）

## 验收标准

- [ ] 对任意选区可返回结构化上下文包（含来源引用）
- [ ] 同时支持 FTS5（关键词）与 sqlite-vec（语义）两路召回
- [ ] 上下文包具备预算控制（超限会裁剪），不会导致 prompt 无限制膨胀
- [ ] 检索失败时返回明确错误信息与证据（禁止 silent failure）

## 参考

- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 227-257 行（RAG 流程与检索策略）
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 261-263 行（段落级/实体级/章节级检索粒度）

