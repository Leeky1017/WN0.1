# Sprint IDE-Advanced：客观创作工具（时间线 / 出场追踪 / 大纲同步 / 风格样本）

## Purpose

交付 WriteNow 的 IDE-Advanced 能力：以“**客观工具赋能，不做主动判断**”为原则，为创作者提供可回溯证据的项目洞察能力（时间线可视化、人物出场追踪、大纲-正文双向同步、风格样本库），增强掌控感而非被指点感。

本规范是 `openspec/specs/writenow-spec/spec.md` 的可执行增量，复用 Sprint 5 的项目/人物卡/大纲/知识图谱底座，并为后续“用户触发”的分析类 SKILL（例如一致性检查、风格对比）提供数据与交互入口。

## Requirements

### Requirement: 系统 MUST 以客观呈现为默认，且不得主动指错

系统提供的 IDE-Advanced 信息 MUST 是“可回溯证据的客观呈现”，而非“系统判断”。系统 MUST 避免主动弹出矛盾/风格偏离等指责式提示，避免打扰创作。

#### Scenario: 信息展示必须可回溯证据
- **WHEN** 系统展示任意“时间线事件 / 出场记录 / 大纲绑定 / 风格样本”条目
- **THEN** 每条信息必须携带可定位证据（至少：来源文档、章节/位置、可点击跳转），避免“黑箱结论”

#### Scenario: 潜在矛盾不得自动升级为警告
- **WHEN** 系统发现同一实体存在看似冲突的信息（例如“死亡@第二章”与“第五章仍出场”）
- **THEN** 系统必须以“事实并列 + 证据”方式呈现，而不是自动弹出“矛盾/错误”警告
- **THEN** 任何“矛盾检测/一致性结论”必须由用户显式触发（见 Out of Scope）

#### Scenario: IDE-Advanced 不得阻塞写作
- **WHEN** 时间线/出场索引/大纲绑定更新失败或耗时过长
- **THEN** 系统必须提供可观测状态（失败/进行中/可重试）并允许用户继续写作，不得卡死在 loading

---

### Requirement: 时间线引擎 MUST 支持提取、存储与可视化，并可回溯证据

系统 MUST 为项目生成“时间线视图”，用于客观呈现事件与时间点；时间线数据 MUST 可持久化并可按需更新，且每条事件均可跳转回正文证据位置。

#### Scenario: 时间线可生成与浏览
- **WHEN** 用户在项目内打开「时间线」视图
- **THEN** 系统应展示时间线（可按故事时间或出现顺序排序），并展示每条事件的摘要、关联角色（如可得）与证据跳转入口

#### Scenario: 未生成时提供明确的生成入口
- **WHEN** 项目尚未生成时间线或时间线已过期
- **THEN** 系统必须提供明确的“生成/刷新”入口与最后更新时间，并能在生成过程中显示进度/状态

#### Scenario: 时间线条目可定位到正文
- **WHEN** 用户点击某个时间线条目
- **THEN** 编辑器必须定位到对应证据位置（至少定位到所属章节；优先精确定位到句段范围）

---

### Requirement: 人物出场追踪 MUST 基于索引可视化，并可定位到正文

系统 MUST 为项目内人物提供出场追踪：至少按人物卡片的 `name`（可扩展 aliases）在正文中进行匹配，生成可浏览的出场列表，并可跳转回正文。

#### Scenario: 出场列表可用
- **WHEN** 用户打开「人物出场」视图并选择某个人物
- **THEN** 系统应展示该人物的出场记录列表（至少包含：章节/位置、上下文片段、次数统计），并提供跳转入口

#### Scenario: 人物名/别名变更后可更新索引
- **WHEN** 用户更新人物卡片的名称或别名集合
- **THEN** 系统必须允许刷新该人物的出场索引，并更新视图展示（旧索引不得静默沿用）

#### Scenario: 命中结果应保持中立
- **WHEN** 系统匹配到可能歧义的名称命中（例如同名/昵称/常见词）
- **THEN** 系统应以“命中记录 + 证据片段”呈现，并允许用户自行判断；不得自动给出“误用/写错”结论

---

### Requirement: 大纲与正文 MUST 支持双向定位，并提供稳定的结构绑定

系统 MUST 在大纲节点与正文内容之间建立稳定绑定：支持从大纲定位正文、从正文定位大纲；当绑定失效时必须可观测并可恢复（例如提示重新绑定）。

#### Scenario: 大纲定位正文
- **WHEN** 用户点击某个大纲节点
- **THEN** 编辑器必须定位到该节点绑定的正文范围（至少定位到对应章节标题；优先精确定位到段落范围）

#### Scenario: 正文定位大纲
- **WHEN** 用户在编辑器中移动光标或选中一段正文
- **THEN** 大纲视图应高亮/定位到当前正文所属的大纲节点（如无法判定，应显示“未绑定”状态而非错误绑定）

#### Scenario: 绑定失效必须可恢复
- **WHEN** 由于用户重写/删改导致绑定范围无法再可靠定位
- **THEN** 系统必须显示“绑定失效/待修复”状态，并提供重新绑定入口；不得 silent failure

---

### Requirement: 风格样本库 MUST 支持用户标记、检索与注入（仅用户触发）

系统 MUST 支持用户将满意的段落保存为“风格样本”，并在用户显式触发的 SKILL 中注入为参考（例如“对齐此风格润色/模仿此风格扩写”）。样本 MUST 持久化保存并可检索。

#### Scenario: 保存风格样本
- **WHEN** 用户选中一段文本并选择“保存为风格样本”
- **THEN** 系统必须将样本持久化（至少包含：文本内容、来源文档、可选标签/备注、创建时间），并在样本库中可浏览

#### Scenario: 检索与引用风格样本
- **WHEN** 用户在样本库中搜索/筛选并选择一个样本（或多个样本）
- **THEN** 系统应展示样本内容与来源，并允许将其作为“参考风格”用于后续用户触发的 SKILL（不得自动注入）

#### Scenario: 样本库不可用时可降级
- **WHEN** 样本库索引（例如 embedding 建立）失败或尚未就绪
- **THEN** 系统仍应允许样本被保存与按关键词/标签检索，且提供可重试的索引构建入口

## Out of Scope（IDE-Advanced 不包含）

- 实时自动矛盾检测
- 自动风格偏离警告
- 任何“系统告诉你哪里错了”的主动提示（包括 toast/弹窗/红线标注等）
- P1（可选，用户触发 SKILL）：一致性检查、风格对比、实体抽取建议（本 Sprint 仅提供数据与入口，不提供结论型自动提示）

## Notes（实现约束与建议）

- 低打扰：索引/生成应在用户显式触发或可控的低优先级策略下进行，且不得影响编辑器输入性能。
- 可解释：所有高级视图应优先展示“证据”而非“结论”；允许作者故意“风格突变/人死复活”。
- 复用底座：优先复用 Sprint 5 的人物卡/大纲/知识图谱结构，避免引入双栈或并行数据源。

## References

- 核心规范：`openspec/specs/writenow-spec/spec.md`（上下文注入：人物时间线/出场记录；外挂记忆：风格样本）
- Sprint 5：`openspec/specs/sprint-5-project/spec.md`（人物卡/大纲/知识图谱底座）
- Sprint 3：`openspec/specs/sprint-3-rag/spec.md`（索引与检索闭环）
