# 6 层记忆架构设计（Layer 0–5）

本设计将“ChatGPT 四层记忆”与 WriteNow 的创作场景合并为 **6 层**，并显式区分：
- **稳定前缀（Layer 0–3）**：尽量稳定、可缓存、低频变更
- **半稳定摘要（Layer 4）**：轻量、可替换，但必须确定性序列化
- **当前上下文（Layer 5）**：高频变化、放在最后、可裁剪

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│ Layer 0: System Instructions                            │ ← 静态，定义行为与约束（稳定前缀）
├─────────────────────────────────────────────────────────┤
│ Layer 1: Session Context                                │ ← 临时：设备/时间/项目/编辑器状态（稳定前缀）
├─────────────────────────────────────────────────────────┤
│ Layer 2: User Profile Memory                            │ ← 持久：用户偏好/风格/反馈学习（稳定前缀）
├─────────────────────────────────────────────────────────┤
│ Layer 3: Project Knowledge Memory                       │ ← 项目级：人物/世界观/风格指南（稳定前缀）
├─────────────────────────────────────────────────────────┤
│ Layer 4: Recent Interactions Summary                    │ ← 轻量：最近会话/最近 SKILL 运行摘要
├─────────────────────────────────────────────────────────┤
│ Layer 5: Current Context                                │ ← 实时：选区/前后文/当前任务/局部检索
└─────────────────────────────────────────────────────────┘
```

## Layer 规范（来源/持久化/预算）

| Layer | 内容 | 来源 | 持久化 | 更新频率 | 默认 Token 预算 | 序列化形式（建议） |
|------:|------|------|--------|----------|-----------------|-------------------|
| 0 | 系统指令/不变量 | 内置常量（`ai.cjs`）+ `AGENTS.md` 的关键约束摘录 | N/A | 极低 | 800–1500 | Markdown 固定章节 |
| 1 | 会话/设备/项目元信息 | renderer 状态 + main 运行态 | 可选（run meta） | 中 | 150–400 | 稳定 key=value 列表 |
| 2 | 用户偏好（显式+隐式） | `memory.cjs` | SQLite | 中 | 200–600 | “规则列表 + 置信度” |
| 3 | 项目设定/人物卡/风格指南 | `characters.cjs` / 项目文件 | 文件 + SQLite 索引 | 低 | 300–1200 | “引用 + 必要片段” |
| 4 | 最近运行摘要/对话摘要 | `context.cjs` compaction | SQLite + 文件 | 中 | 200–800 | 结构化摘要（JSON→稳定 Markdown） |
| 5 | 选区/前后文/当前任务 | 编辑器选区 + retrieval | N/A（可写 run snapshot） | 高 | 800–3000 | 原文 + 裁剪策略说明 |

> 预算是“默认上限”，真实注入必须遵循 `context_rules`（按 SKILL 类型调整）。

## 注入顺序与稳定性约束

### 固定顺序（MUST）

1. Layer 0
2. Layer 1
3. Layer 2
4. Layer 3
5. Layer 4
6. Layer 5

### 稳定前缀（Layer 0–3）

- **章节标题与顺序 MUST 固定**（例如始终为：`## 角色/行为约束` → `## 会话信息` → `## 用户偏好` → `## 项目设定`）
- Layer 2/3 的内容变化也必须 **确定性序列化**（排序、空行、缩进一致），否则会导致 KV-cache 失效

### 动态层（Layer 4–5）

- Layer 4 可被替换为新的摘要，但替换必须使用确定性序列化（相同摘要→相同文本）
- Layer 5 必须放在最后，并允许严格裁剪；裁剪结果必须可解释（写入 “裁剪策略/证据引用”）

## 与 WriteNow 现有“上下文层次”映射

`writenow-spec` 中的“项目/文章/段落/指令”层次可映射为：

- 项目级（人物/世界观/风格指南）→ Layer 3
- 段落级（选区 + surrounding）→ Layer 5
- 指令级（SKILL prompt/输出格式）→ Layer 0（模板的一部分）+ Layer 5（当前任务）
- 历史压缩（可逆/不可逆摘要）→ Layer 4

