# 任务 005: 人物/设定智能检索

## 目标

以“人物/设定卡片”为第一优先级，实现选区/指令中的人物与设定识别、索引与召回；在基础 RAG 上下文包中稳定提供相关人物关系、设定摘要与证据引用，支撑后续生成对话/续写/一致性检查等 SKILL。

## 依赖

- 任务 002：FTS5 全文索引（实体名精确/前缀召回）
- 任务 003：sqlite-vec 向量存储（语义召回兜底）
- 任务 004：基础 RAG 检索逻辑（上下文包组装与预算控制）

## 实现步骤

1. 定义“卡片”数据结构与来源：
   - 人物卡：姓名/别名/关系/性格/动机/外观/关键事件
   - 设定卡：地点/组织/规则/时间线节点/世界观条目
   - 来源可来自：独立卡片文件、项目元数据或从正文抽取（策略可迭代）
2. 实体识别（最小可用）：
   - 选区/指令中识别人名/地点/专有名词（字典 + 规则优先）
   - 允许用户显式指定实体（例如 `@角色名`）作为强提示
3. 建立实体索引：
   - FTS：卡片内容与别名字段进入全文索引
   - 向量：卡片全文生成 embedding 并写入 sqlite-vec
4. 召回策略与排序：
   - 精确匹配（name/alias）优先
   - 语义召回兜底（与选区 embedding 做相似检索）
   - 多实体支持：按重要性/出现次数排序并做预算裁剪
5. 将实体结果注入上下文包：
   - 在 RAG 输出中新增 `characters[]` / `settings[]`
   - 每条卡片附带来源引用（文件/片段）与更新时间（便于冲突定位）

## 新增/修改文件

- `electron/lib/rag/entities.cjs` - 实体识别与召回逻辑（新增）
- `electron/db/schema.sql` - 实体表/索引表（修改）
- `electron/lib/rag/retrieval.cjs` - 上下文包注入（修改）

## 验收标准

- [ ] 给定选区/指令中出现的人物名/设定关键词，可召回对应卡片
- [ ] 精确召回优先，语义召回兜底；支持多实体并做预算裁剪
- [ ] 每条卡片附带来源引用，便于一致性检查 SKILL 使用

## 参考

- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 236-242 行（人物设定卡片/世界观设定等检索目标）
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 251-258 行（不同 SKILL 的检索内容）

