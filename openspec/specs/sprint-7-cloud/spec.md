# Sprint 7：云服务（3 周）

## Purpose

在 Sprint 7 内交付 WriteNow 的「云服务」闭环：完成 Supabase 用户认证、Stripe 订阅管理、云同步（Pro）、以及 Pro 功能上线所需的权限控制与产品化交互。该 Sprint 的核心目标是：让用户可以在多设备间安全同步创作资产，并通过清晰可控的付费体系获得 Pro 权益，同时保持 WriteNow 的 **local-first** 写作体验（离线可用、云端为增强而非前置条件）。

本规范是 `openspec/specs/writenow-spec/spec.md` 在 Sprint 7 范围内的可执行增量（Cloud：Auth / Billing / Sync / Entitlements）。

## Requirements

### Requirement: 应用 MUST 集成 Supabase Auth，并提供稳定的登录/会话体验

应用 MUST 支持用户注册/登录/登出，并在应用重启后恢复会话；同时必须保证：未登录用户仍可正常使用本地编辑能力（云能力与 Pro 权益受限），避免“登录墙”破坏写作流。

#### Scenario: 注册 / 登录 / 登出闭环
- **WHEN** 用户在设置页/引导页选择注册或登录（邮箱+密码或后续扩展的 OAuth）
- **THEN** 应完成 Supabase Auth 流程并在 UI 中进入“已登录”态，能够看到当前账号信息
- **WHEN** 用户点击登出
- **THEN** 应清理本地会话并切换为“未登录”态，同时不影响本地数据的继续使用

#### Scenario: 会话可恢复且不会静默失效
- **WHEN** 用户登录后关闭应用并重新启动
- **THEN** 应自动恢复到已登录态（若 refresh 失败必须给出明确提示与重登入口，禁止 silent failure）

#### Scenario: 网络不可用时的降级
- **WHEN** 用户离线启动应用
- **THEN** 本地编辑与本地数据访问必须可用；云同步入口应显示离线状态与重试机制

---

### Requirement: 系统 MUST 支持 Stripe 订阅管理，并将订阅状态映射为 Pro 权益

系统 MUST 提供“升级为 Pro”的订阅购买入口，并通过 Stripe 结算；订阅状态必须可被客户端可靠读取，用于开启/关闭 Pro 权益（例如云同步、自定义 SKILL、高端模型等，详见权限矩阵）。

#### Scenario: 发起订阅购买（Checkout）
- **WHEN** 已登录用户在「升级 Pro」入口点击购买
- **THEN** 系统应创建 Stripe Checkout Session 并引导用户完成支付；支付成功后应用内应在合理时间内变为 Pro（允许短暂延迟但必须有刷新/重试机制）

#### Scenario: 订阅状态变更可追踪（Webhooks）
- **WHEN** Stripe 产生订阅生命周期事件（成功/续费/取消/到期/退款等）
- **THEN** 系统应通过服务端 Webhook（或等价机制）更新用户的订阅状态；并保证幂等处理（重复事件不应导致错误状态）

#### Scenario: 用户可自助管理订阅
- **WHEN** Pro 用户在设置页进入「订阅管理」
- **THEN** 应能打开 Stripe Customer Portal（或等价入口），支持取消/恢复/更新支付方式，并在返回应用后同步最新订阅状态

---

### Requirement: Pro 用户 MUST 支持云同步（Cloud Sync），并保持 local-first

云同步 MUST 面向 Pro 用户提供：项目/文档等核心创作资产的跨设备同步；同步必须支持离线队列与可恢复重试，且不得阻塞本地写作与保存（云端失败不得导致本地数据丢失）。

#### Scenario: 首次开启云同步的初始化
- **WHEN** Pro 用户在某台设备开启云同步
- **THEN** 系统应执行一次初始化同步：将本地的最小同步集上传至云端并记录同步游标/版本信息（实现策略可选，但必须可恢复）

#### Scenario: 增量同步与后台重试
- **WHEN** 用户在离线或弱网环境下继续写作与保存
- **THEN** 变更应进入本地同步队列；网络恢复后自动重试并最终与云端一致（失败必须可见、可重试、可诊断）

#### Scenario: 新设备拉取与一致性
- **WHEN** Pro 用户在新设备登录并开启云同步
- **THEN** 系统应拉取云端数据并在本地落盘；完成后用户应能看到与其他设备一致的项目与文档列表

---

### Requirement: 同步冲突 MUST 可检测，并提供无数据丢失的解决流程

当多设备对同一资产并发修改导致冲突时，系统 MUST 能检测冲突并进入“可见、可理解、可操作”的解决流程，禁止静默覆盖。

#### Scenario: 冲突检测
- **WHEN** 同一文档在两台设备离线编辑后先后同步到云端
- **THEN** 系统必须检测到版本分叉（冲突），并阻止直接覆盖

#### Scenario: 用户可基于 Diff 解决冲突
- **WHEN** 用户进入冲突解决界面
- **THEN** 应能看到本地版本与云端版本的差异（Diff 或等价呈现），并选择：保留本地/保留云端/保留两份/手动合并（至少实现前两项，后两项为推荐）

#### Scenario: 解决结果可追溯
- **WHEN** 用户完成冲突解决
- **THEN** 系统应生成一条可追溯记录（至少包含时间、选择、影响的文档 id），避免“发生过但不可追查”

---

### Requirement: 功能权限 MUST 依据套餐矩阵强制执行（客户端 + 服务端）

系统 MUST 基于套餐（Free/Pro/Team）实现功能权限控制。客户端必须对入口与交互进行 gating（含升级引导），服务端必须对云端数据访问进行隔离（例如 RLS），确保越权不可行。

#### Scenario: Free 用户访问 Pro 功能的显式阻断
- **WHEN** Free 用户尝试使用云同步或其他 Pro-only 功能
- **THEN** UI 必须明确提示“需要 Pro”并提供升级入口；同时不得向云端写入需要 Pro 权限的数据

#### Scenario: Pro 权益生效与过期处理
- **WHEN** 用户订阅状态从 Free → Pro（或 Pro → 过期）
- **THEN** 应在应用内反映为权限即时切换（允许短暂缓存但需可刷新），并对过期状态提供可理解的恢复/续费路径

#### Scenario: 云端数据隔离
- **WHEN** 任意用户尝试访问云端数据
- **THEN** 云端必须确保数据按用户隔离（同账号可跨设备访问；不同账号禁止访问），并对越权请求返回明确错误

## Out of Scope（Sprint 7 不包含）

- Team 方案的团队协作与统一账单（仅做能力预留，不做完整交付）
- 国内支付（微信支付等）与多币种/税务合规
- 实时协作编辑（OT/CRDT）与多人并发同文档编辑
- 复杂的云端版本历史对齐、全量回滚与审计后台

## Notes（实现约束与建议）

- Local-first：云同步与订阅能力不得影响本地写作/保存的可用性；任何云端失败都必须可见且可恢复。
- 安全边界：Stripe 密钥、Webhook 密钥等必须只存在于服务端（Supabase Edge Functions 或等价后端），客户端仅持有公开的 Supabase `anon` key。
- 数据隔离：优先采用 Supabase RLS 进行按用户隔离；同步相关表应包含 `user_id` 作为分区维度。
- 同步策略：建议以“版本号/更新时间 + 游标”的方式实现最小可用增量同步；冲突策略建议以“检测分叉→进入 UI 解决”替代静默 LWW。
- 透明性：设置页应提供云同步开关、订阅状态、以及数据使用说明入口（与核心规范的隐私模式保持一致）。

## References

- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 361-384 行（隐私与数据：默认/隐私模式、云端数据、透明性）
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 552-586 行（商业模型：套餐/权限矩阵/后端技术栈：Supabase/Stripe）
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 896-900 行（Sprint 7 范围）
