# 任务 004: 同步冲突处理

## 目标

在云同步中实现可靠的冲突检测与解决流程：当同一资产在多设备并发修改导致版本分叉时，系统必须检测冲突并提供无数据丢失的解决方案（禁止静默覆盖）。

## 依赖

- 任务 003：云同步核心逻辑（需要同步引擎与基础数据模型）
- 现有 Diff/对比能力（可复用 AI Diff 组件或实现一个轻量文本 Diff 视图）

## 实现步骤

1. 冲突判定规则（最小可用）：
   - 定义“版本分叉”检测：例如基于 `version`/`updated_at` + last_synced_watermark
   - 任何不确定的情况都应进入“需要人工确认”的冲突流程（宁可多报，禁止漏报覆盖）
2. 冲突数据结构：
   - 在本地落盘冲突记录：资产 id、本地版本快照、云端版本快照、发生时间、状态（待处理/已解决）
3. UI 冲突中心：
   - 在设置页或侧边栏提供「同步冲突」入口与列表
   - 提供至少两种解决动作：保留本地 / 保留云端（推荐：保留两份、手动合并）
4. 应用解决结果：
   - 将选择结果写回本地与云端，更新同步水位线
   - 全程保证：不会丢失任何一个版本的内容
5. 可追溯性：
   - 记录每次解决的选择与时间，并能在必要时回看（最小：日志/记录表）

## 新增/修改文件（建议）

- `electron/ipc/syncConflicts.cjs` - 冲突记录与解决应用（新增）
- `src/stores/syncConflictStore.ts` - 冲突列表与状态（新增）
- `src/components/sync/ConflictResolver.tsx` - Diff + 解决 UI（新增）

## 验收标准

- [ ] 并发修改场景下可检测到冲突，且不会静默覆盖
- [ ] 用户可在 UI 中选择保留本地/保留云端并成功解决
- [ ] 解决后本地与云端达到一致，且冲突记录可追溯

## 参考

- Sprint 7 规范：`openspec/specs/sprint-7-cloud/spec.md`
- 核心规范：`openspec/specs/writenow-spec/spec.md` 第 347-360 行（Diff 展示与确认机制：交互参考）
