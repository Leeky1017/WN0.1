name: theia-windows-smoke

on:
  workflow_dispatch:

jobs:
  smoke:
    name: theia-windows-smoke
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack (Yarn Classic)
        run: |
          corepack enable
          corepack prepare yarn@1.22.22 --activate
          yarn --version

      - name: Install (writenow-theia)
        env:
          # Helps avoid GitHub API rate limits for deps that download assets.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd writenow-theia
          yarn install:win --frozen-lockfile

      - name: Build electron target (writenow-theia)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd writenow-theia
          yarn build:electron:win

      - name: Start browser target (smoke)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd writenow-theia

          $stdout = Join-Path $env:RUNNER_TEMP "theia-browser.stdout.log"
          $stderr = Join-Path $env:RUNNER_TEMP "theia-browser.stderr.log"
          $proc = Start-Process -FilePath "cmd.exe" -ArgumentList @("/c","yarn","--cwd","browser-app","start","--hostname","127.0.0.1","--port","3012") -NoNewWindow -PassThru -RedirectStandardOutput $stdout -RedirectStandardError $stderr
          Start-Sleep -Seconds 25

          Write-Host "---- browser stdout (tail) ----"
          Get-Content $stdout -Tail 120

          Write-Host "---- browser stderr (tail) ----"
          Get-Content $stderr -Tail 120

          try {
            Invoke-WebRequest -Uri "http://127.0.0.1:3012" -UseBasicParsing | Out-Null
            Write-Host "HTTP GET ok"
          } catch {
            Write-Host "HTTP GET failed"
            throw
          } finally {
            Stop-Process -Id $proc.Id -Force
          }

      - name: Start electron target (smoke)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd writenow-theia

          $stdout = Join-Path $env:RUNNER_TEMP "theia-electron.stdout.log"
          $stderr = Join-Path $env:RUNNER_TEMP "theia-electron.stderr.log"
          $proc = Start-Process -FilePath "cmd.exe" -ArgumentList @("/c","yarn","--cwd","electron-app","start") -NoNewWindow -PassThru -RedirectStandardOutput $stdout -RedirectStandardError $stderr
          Start-Sleep -Seconds 25

          Write-Host "---- electron stdout (tail) ----"
          Get-Content $stdout -Tail 200

          Write-Host "---- electron stderr (tail) ----"
          Get-Content $stderr -Tail 200

          $content = (Get-Content $stdout -Raw) + \"`n\" + (Get-Content $stderr -Raw)
          if ($content -notmatch "\\[writenow-core\\] frontend started") {
            throw "Expected frontend contribution log not found"
          }

          Stop-Process -Id $proc.Id -Force
