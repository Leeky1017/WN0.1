# WriteNow Testing Standards

> 本文档定义 WriteNow 的测试规范。所有测试必须遵循 `AGENTS.md` 的“宪法级约束”（用户路径优先、100% 功能覆盖、边界条件必测、禁止假数据替代真实逻辑）。

## 5.1 测试原则

- 用户路径优先：测试必须覆盖真实用户会走的关键路径（创建→编辑→保存→恢复等）
- 100% 功能覆盖：每个功能点必须同时覆盖 **正常路径 / 错误路径 / 边界条件**
- 边界条件必测：空值、极限值、特殊字符、并发/竞态必须显式覆盖
- 可复现：失败必须给出可定位信息（日志、错误码、最小复现输入）

## 5.2 测试分类

### 单元测试（Unit）

适用范围：
- 纯函数与工具函数（`src/lib/`）
- 类型转换、校验逻辑、diff/patch 生成等

要求：
- 不依赖 Electron 环境
- 输入/输出完全可控，边界用例齐全

### 集成测试（Integration）

适用范围：
- IPC 通道（Renderer↔Main 的请求/响应与错误映射）
- Zustand store 的异步 action（与 IPC/持久化交互）

要求：
- 覆盖通道协议（Envelope + 错误码）与关键失败场景
- 禁止用“假数据”跳过真实逻辑：允许 mock 外部依赖（网络/模型），但必须验证核心业务分支

### E2E 测试（End-to-End）

适用范围：
- 完整用户流程（真实 Electron 启动、真实窗口交互、真实落盘/数据库）

要求：
- 以用户行为驱动（点击、输入、快捷键、等待保存状态变化）
- 必须覆盖崩溃恢复、并发操作等高风险路径（如适用）

## 5.3 测试命名规范

- `describe`: 被测试模块/功能（例如 `filesStore`, `file:write`, `AutoSave`）
- `it/test`: `should ...` + 明确预期行为

示例：

```ts
describe('file:read', () => {
  it('should return content for an existing markdown file', async () => {
    // ...
  })
})
```

## 5.4 边界测试清单（必做）

- 空值/undefined/null
- 空字符串/空数组/空对象
- 超长字符串（大文件内容、超长标题/文件名）
- 特殊字符（emoji、CJK、Windows 不合法字符、路径穿越尝试等）
- 并发操作（并发保存/删除、快速切换文件、重复点击）
- 网络异常（AI/更新等依赖网络的场景：超时、限流、断网）
- 资源限制（磁盘不可写、权限不足、数据库锁冲突）

## 5.5 禁止事项

- 禁止 `skip` / `only` / 临时注释测试逃避失败
- 禁止只测 happy path
- 禁止使用假数据替代真实逻辑（mock 仅用于隔离不可控外部依赖）
- 禁止忽略边界条件与错误路径

## 5.6 覆盖率与质量门禁（建议）

- 覆盖率门禁必须在 CI 中执行并阻止回退
- 对核心路径（文件读写、编辑器保存/恢复、IPC 错误映射）应设置更严格的阈值
- 任何未覆盖分支必须给出明确理由并在 issue/PR 讨论中记录

> 注：当前仓库的测试工具链（如 Vitest/Playwright）可在后续任务中引入；本规范先作为统一标准，避免实现与测试策略漂移。

