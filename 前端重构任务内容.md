# WriteNow 前端重构规范（Sprint Frontend V2）

## 元信息

| 字段 | 值 |
|------|-----|
| 规范名称 | sprint-frontend-v2 |
| 状态 | Draft |
| 创建时间 | 2026-01-25 |
| 上游依赖 | writenow-spec/spec.md |
| 目标 | 脱离 Theia 前端，构建独立的高质量 React 前端 |

---

## 一、背景与动机

### 1.1 当前问题

| 问题 | 说明 |
|------|------|
| **Theia 前端无法高度定制** | CSS 特异性战争、样式污染、布局系统不可控 |
| **UI 达不到产品级水准** | 无法实现 Cursor/Linear 级别的精美设计 |
| **开发效率低** | 每次样式调整都要与 Theia 默认样式对抗 |
| **学习曲线陡峭** | Widget/Contribution Point 体系复杂 |

### 1.2 决策

| 决策项 | 决定 | 理由 |
|--------|------|------|
| Theia 后端 | **保留** | 后端服务已完善，无需重写 |
| Theia 前端 | **弃用** | 无法满足设计要求 |
| 新前端技术栈 | **Vite + React + Tailwind** | 现代、快速、完全可控 |

### 1.3 目标效果

**参考产品**（按优先级）：
1. **Cursor** — IDE 布局、深色主题、命令面板
2. **Linear** — 极简设计、动效、色彩克制
3. **Notion** — 编辑器体验、块级编辑
4. **Obsidian** — 文件树、分屏、本地优先

---

## 二、整体架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│  Electron 应用                                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  主进程（Main Process）                                      ││
│  │  - 启动 Theia 后端服务                                       ││
│  │  - 创建 BrowserWindow                                        ││
│  │  - 处理系统级事件（菜单、托盘、更新）                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                              ↑↓ IPC                               │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  渲染进程（Renderer Process）                                ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │  新前端（writenow-frontend/）                           │││
│  │  │  - React 18 + TypeScript                                │││
│  │  │  - Vite 构建                                            │││
│  │  │  - Tailwind CSS + Design Tokens                         │││
│  │  │  - 组件库（shadcn/ui + Radix）                          │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
│                              ↑↓ WebSocket (JSON-RPC)              │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Theia 后端（writenow-theia/writenow-core/src/node/）       ││
│  │  - 文件服务、项目服务、版本服务                               ││
│  │  - AI 服务（流式推送）                                        ││
│  │  - RAG、知识图谱、向量搜索                                    ││
│  │  - SQLite 数据库                                              ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
WriteNow/
├── writenow-theia/              # 【保留】Theia 后端
│   └── writenow-core/src/node/  # 后端服务（不动）
│
├── writenow-frontend/           # 【新建】独立前端
│   ├── src/
│   │   ├── app/                 # 应用入口
│   │   ├── components/          # 通用组件
│   │   │   ├── ui/              # 基础 UI 组件（shadcn/ui）
│   │   │   ├── layout/          # 布局组件
│   │   │   ├── editor/          # 编辑器组件
│   │   │   └── panels/          # 面板组件
│   │   ├── features/            # 功能模块
│   │   │   ├── file-tree/       # 文件树
│   │   │   ├── ai-panel/        # AI 面板
│   │   │   ├── version-history/ # 版本历史
│   │   │   └── settings/        # 设置
│   │   ├── lib/                 # 工具库
│   │   │   ├── rpc/             # RPC 客户端
│   │   │   ├── hooks/           # React Hooks
│   │   │   └── utils/           # 工具函数
│   │   ├── stores/              # 状态管理
│   │   └── styles/              # 样式系统
│   │       ├── tokens.css       # Design Tokens
│   │       ├── themes/          # 主题定义
│   │       └── globals.css      # 全局样式
│   ├── electron/                # Electron 集成
│   │   ├── main.ts              # 主进程入口
│   │   └── preload.ts           # 预加载脚本
│   ├── public/                  # 静态资源
│   ├── index.html
│   ├── vite.config.ts
│   ├── tailwind.config.ts
│   ├── tsconfig.json
│   └── package.json
│
├── src/                         # 【保留】共享类型
│   ├── types/                   # IPC 类型定义
│   └── locales/                 # 国际化
│
└── electron/                    # 【保留】共享资源
    └── skills/                  # 内置 SKILL 包
```

---

## 三、技术选型

### 3.1 核心框架

| 类别 | 选择 | 版本 | 理由 |
|------|------|------|------|
| **构建工具** | Vite | 6.x | 极速 HMR，开箱即用 TypeScript |
| **UI 框架** | React | 18.x | 生态成熟，组件丰富 |
| **类型系统** | TypeScript | 5.x | 类型安全，与后端共享类型 |
| **样式方案** | Tailwind CSS | 4.x | 原子化 CSS，与 Design Token 配合 |
| **桌面容器** | Electron | 34.x | 成熟稳定，与后端集成方便 |
| **构建集成** | electron-vite | 3.x | Vite + Electron 最佳实践 |

### 3.2 UI 组件库

| 类别 | 选择 | 理由 |
|------|------|------|
| **基础组件** | shadcn/ui | 复制粘贴架构，完全可控，基于 Radix |
| **无障碍原语** | Radix UI | 无样式、可访问、键盘导航完善 |
| **图标** | Lucide React | 与 shadcn/ui 配套，Linear 风格 |

### 3.3 功能组件

| 功能 | 选择 | GitHub Stars | 理由 |
|------|------|--------------|------|
| **编辑器** | TipTap | 29k+ | 基于 ProseMirror，Markdown 友好，已在用 |
| **文件树** | react-arborist | 3k+ | 虚拟化、拖拽、性能优秀 |
| **布局系统** | FlexLayout | 1.2k+ | IDE 级 dock panel，成熟稳定 |
| **命令面板** | cmdk | 12k+ | Cursor/Linear 同款，无样式可定制 |
| **通知** | sonner | 12k+ | Emil Kowalski 出品，动效精美 |
| **动画** | Framer Motion | 27k+ | 手势/过渡动画，性能优秀 |

### 3.4 状态管理

| 类别 | 选择 | 理由 |
|------|------|------|
| **全局状态** | Zustand | 轻量、简单、与 React 18 配合好 |
| **服务端状态** | TanStack Query | 缓存、重试、乐观更新 |

### 3.5 通信层

| 类别 | 选择 | 理由 |
|------|------|------|
| **协议** | JSON-RPC 2.0 | 与 Theia 后端兼容 |
| **传输** | WebSocket | 支持双向通信（AI 流式推送） |
| **客户端库** | vscode-ws-jsonrpc | Theia 同款，开箱即用 |

---

## 四、设计系统

### 4.1 设计原则

**学习对象**：
- **Cursor**：深色主题、紧凑布局、无干扰
- **Linear**：极简色彩、微妙动效、专业感
- **Notion**：内容优先、留白、呼吸感

**核心原则**：
1. **内容优先**：UI 服务于内容，不喧宾夺主
2. **色彩克制**：主色只用一个蓝色，其余都是灰色
3. **动效有意义**：只在需要引导注意力时使用动画
4. **一致性**：所有组件遵循同一套 Token

### 4.2 Design Tokens

```css
:root {
  /* ===== 基础色板（Cursor 风格） ===== */
  --gray-50: #fafafa;
  --gray-100: #f4f4f5;
  --gray-200: #e4e4e7;
  --gray-300: #d4d4d8;
  --gray-400: #a1a1aa;
  --gray-500: #71717a;
  --gray-600: #52525b;
  --gray-700: #3f3f46;
  --gray-800: #27272a;
  --gray-850: #1f1f23;
  --gray-900: #18181b;
  --gray-950: #09090b;

  /* ===== 主题色（Linear 风格低饱和蓝） ===== */
  --blue-50: #eff6ff;
  --blue-100: #dbeafe;
  --blue-200: #bfdbfe;
  --blue-300: #93c5fd;
  --blue-400: #60a5fa;
  --blue-500: #3b82f6;  /* 主色 */
  --blue-600: #2563eb;
  --blue-700: #1d4ed8;

  /* ===== 语义色 ===== */
  --color-success: #22c55e;
  --color-warning: #f59e0b;
  --color-error: #ef4444;

  /* ===== 深色主题语义变量 ===== */
  --bg-app: var(--gray-950);
  --bg-sidebar: var(--gray-900);
  --bg-panel: var(--gray-850);
  --bg-editor: var(--gray-900);
  --bg-input: var(--gray-800);
  --bg-hover: var(--gray-800);
  --bg-active: var(--gray-700);

  --text-primary: var(--gray-50);
  --text-secondary: var(--gray-300);
  --text-muted: var(--gray-500);

  --border-subtle: var(--gray-800);
  --border-default: var(--gray-700);

  --accent: var(--blue-500);
  --accent-hover: var(--blue-400);

  /* ===== 间距 ===== */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-6: 24px;
  --space-8: 32px;

  /* ===== 圆角（克制，不要太圆） ===== */
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 8px;

  /* ===== 字体 ===== */
  --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
  --font-mono: "SF Mono", "Fira Code", "JetBrains Mono", monospace;

  --text-xs: 11px;
  --text-sm: 12px;
  --text-base: 13px;
  --text-lg: 14px;

  /* ===== 动效 ===== */
  --duration-fast: 100ms;
  --duration-normal: 150ms;
  --duration-slow: 200ms;
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
}
```

### 4.3 主题支持

| 主题 | 说明 |
|------|------|
| **Midnight**（默认） | Cursor 风格深黑 |
| **Dark** | 标准深色 |
| **Light** | 浅色主题 |
| **High Contrast** | 无障碍高对比 |

---

## 五、核心功能模块

### 5.1 布局系统

**使用 FlexLayout 实现 IDE 级布局**：

```
┌─────────────────────────────────────────────────────────┐
│  Title Bar（可选，使用系统标题栏或自定义）               │
├─────────────────────────────────────────────────────────┤
│  ┌──────┬──────────────────────────────┬──────────────┐ │
│  │      │                              │              │ │
│  │ 文件 │          编辑器区域           │   AI 面板   │ │
│  │ 树   │     （支持多标签、分屏）       │              │ │
│  │      │                              │              │ │
│  │      │                              │              │ │
│  │      ├──────────────────────────────┤              │ │
│  │      │    底部面板（可选展开）        │              │ │
│  │      │   （版本历史/终端/日志）       │              │ │
│  └──────┴──────────────────────────────┴──────────────┘ │
├─────────────────────────────────────────────────────────┤
│  Status Bar                                             │
└─────────────────────────────────────────────────────────┘
```

**特性**：
- 面板可拖拽、调整大小
- 面板可最大化、最小化
- 布局状态持久化
- 支持 Tab 分组

### 5.2 文件树

**使用 react-arborist 实现**：

- 虚拟化渲染（支持万级文件）
- 拖拽排序
- 右键菜单（新建/重命名/删除）
- 内联重命名
- 图标系统（文件类型图标）

### 5.3 编辑器

**复用现有 TipTap 编辑器**：

- Markdown 所见即所得
- 浮动工具栏
- 斜杠命令（/命令）
- 块级拖拽
- 代码块语法高亮

**新增**：
- 多标签编辑
- 分屏视图
- 预览模式

### 5.4 AI 面板

**复用现有逻辑，重做 UI**：

- 对话历史
- 流式输出
- Diff 对比
- 斜杠命令（/polish, /expand 等）
- 技能选择器

**新增**：
- 内联 AI（Cmd+K 在编辑器内直接触发）
- 上下文预览（显示发送给 AI 的内容）

### 5.5 命令面板

**使用 cmdk 实现**：

- Cmd+K 全局触发
- 模糊搜索
- 分类（文件/命令/SKILL）
- 最近使用记录
- 键盘导航

### 5.6 设置面板

- 分类设置项
- 搜索过滤
- 即时预览（主题切换等）
- 与后端同步

---

## 六、前后端通信

### 6.1 RPC 客户端

```typescript
// lib/rpc/client.ts
import { listen, MessageConnection } from 'vscode-ws-jsonrpc';

class RpcClient {
  private connection: MessageConnection | null = null;

  async connect(url: string): Promise<void> {
    const socket = new WebSocket(url);
    return new Promise((resolve) => {
      listen({
        webSocket: socket,
        onConnection: (connection) => {
          this.connection = connection;
          connection.listen();
          resolve();
        },
      });
    });
  }

  async invoke<T>(channel: string, payload: unknown): Promise<T> {
    if (!this.connection) throw new Error('Not connected');
    return this.connection.sendRequest('invoke', [channel, payload]);
  }
}

export const rpcClient = new RpcClient();
```

### 6.2 类型安全调用

```typescript
// lib/rpc/api.ts
import type { IpcChannel, IpcInvokePayloadMap, IpcInvokeDataMap } from '@/types/ipc-generated';
import { rpcClient } from './client';

export async function invoke<T extends IpcChannel>(
  channel: T,
  payload: IpcInvokePayloadMap[T]
): Promise<IpcInvokeDataMap[T]> {
  const response = await rpcClient.invoke(channel, payload);
  if (!response.ok) {
    throw new Error(response.error.message);
  }
  return response.data;
}

// 使用示例
const project = await invoke('project:bootstrap', {});
const file = await invoke('file:read', { path: '/article.md' });
```

### 6.3 AI 流式推送

```typescript
// lib/rpc/ai-stream.ts
export function subscribeToAiStream(
  runId: string,
  onDelta: (text: string) => void,
  onDone: (result: string) => void,
  onError: (error: Error) => void
): () => void {
  // 订阅后端推送的 onStreamEvent
  const unsubscribe = aiConnection.onNotification('onStreamEvent', (event) => {
    if (event.runId !== runId) return;
    if (event.type === 'delta') onDelta(event.text);
    if (event.type === 'done') onDone(event.result.text);
    if (event.type === 'error') onError(new Error(event.error.message));
  });
  return unsubscribe;
}
```

---

## 七、Electron 集成

### 7.1 主进程职责

```typescript
// electron/main.ts
import { app, BrowserWindow } from 'electron';
import { spawn } from 'child_process';

let theiaProcess: ChildProcess | null = null;

async function startTheiaBackend(): Promise<void> {
  // 启动 Theia 后端服务
  theiaProcess = spawn('node', ['./theia-backend/main.js'], {
    env: { ...process.env, WRITENOW_THEIA_DATA_DIR: app.getPath('userData') },
  });
  // 等待后端就绪
  await waitForPort(3000);
}

async function createWindow(): Promise<void> {
  const win = new BrowserWindow({
    width: 1400,
    height: 900,
    webPreferences: {
      preload: path.join(__dirname, 'preload.js'),
    },
  });
  // 加载前端
  if (isDev) {
    win.loadURL('http://localhost:5173');
  } else {
    win.loadFile('dist/index.html');
  }
}

app.whenReady().then(async () => {
  await startTheiaBackend();
  await createWindow();
});

app.on('quit', () => {
  theiaProcess?.kill();
});
```

### 7.2 打包配置

```json
// electron-builder.json5
{
  "appId": "com.writenow.app",
  "productName": "WriteNow",
  "directories": {
    "output": "release"
  },
  "files": [
    "dist/**/*",
    "dist-electron/**/*",
    "theia-backend/**/*"
  ],
  "win": {
    "target": ["nsis"],
    "icon": "public/icon.ico"
  },
  "mac": {
    "target": ["dmg"],
    "icon": "public/icon.icns"
  },
  "linux": {
    "target": ["AppImage"],
    "icon": "public/icon.png"
  }
}
```

---

## 八、实施路线

### Phase 0：基础设施（3 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P0-001 | 创建 writenow-frontend 项目骨架 | Vite + React + TypeScript 项目 |
| P0-002 | 配置 Tailwind + Design Tokens | 样式系统就绪 |
| P0-003 | 集成 shadcn/ui 基础组件 | Button/Input/Card 等 |
| P0-004 | 实现 RPC 客户端 | 能连接 Theia 后端 |
| P0-005 | 验证端到端通路 | 调用 project:bootstrap 成功 |

**验收标准**：新前端能成功调用后端接口并显示项目信息。

### Phase 1：核心布局（5 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P1-001 | 集成 FlexLayout 布局系统 | 可拖拽面板布局 |
| P1-002 | 实现文件树（react-arborist） | 浏览/选择文件 |
| P1-003 | 实现 Status Bar | 字数统计、AI 状态 |
| P1-004 | 布局持久化 | 刷新后恢复布局 |

**验收标准**：可以浏览文件、调整布局、看到状态栏。

### Phase 2：编辑器（5 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P2-001 | 迁移 TipTap 编辑器组件 | 打开/编辑文件 |
| P2-002 | 实现多标签编辑 | Tab 切换 |
| P2-003 | 实现文件保存 | 自动保存 + 手动保存 |
| P2-004 | 实现浮动工具栏 | 格式化操作 |

**验收标准**：可以打开、编辑、保存 Markdown 文件。

### Phase 3：AI 面板（5 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P3-001 | 迁移 AI 面板逻辑 | 对话/流式输出 |
| P3-002 | 重做 AI 面板 UI | Cursor 风格 |
| P3-003 | 实现 Diff 视图 | 对比/应用修改 |
| P3-004 | 实现斜杠命令 | /polish, /expand 等 |

**验收标准**：可以选中文字、调用 AI、查看 Diff、应用修改。

### Phase 4：命令面板与设置（3 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P4-001 | 集成 cmdk 命令面板 | Cmd+K 触发 |
| P4-002 | 实现设置面板 | 配置项管理 |
| P4-003 | 实现主题切换 | 深色/浅色主题 |

**验收标准**：Cmd+K 打开命令面板，可切换主题。

### Phase 5：辅助功能（3 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P5-001 | 实现版本历史面板 | 查看/回退版本 |
| P5-002 | 实现通知系统（sonner） | Toast 提示 |
| P5-003 | 实现快捷键系统 | 全局快捷键 |

**验收标准**：版本历史可用，操作有反馈。

### Phase 6：Electron 打包（3 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P6-001 | 配置 electron-vite | 开发环境就绪 |
| P6-002 | 实现主进程启动后端 | 后端自动启动 |
| P6-003 | 配置 electron-builder | 生成安装包 |
| P6-004 | 测试各平台安装包 | Windows/Mac/Linux |

**验收标准**：可生成可安装的桌面应用。

### Phase 7：打磨与优化（5 天）

| 任务 | 说明 | 产出 |
|------|------|------|
| P7-001 | 动效优化（Framer Motion） | 过渡动画 |
| P7-002 | 性能优化 | 懒加载、虚拟化 |
| P7-003 | 无障碍优化 | 键盘导航、ARIA |
| P7-004 | 细节打磨 | hover/focus 效果 |

**验收标准**：达到 Cursor/Linear 级别的视觉和交互质量。

---

## 九、验收标准

### 9.1 功能验收

| 功能 | 标准 |
|------|------|
| 文件浏览 | 可浏览项目文件夹 |
| 文件编辑 | 可打开、编辑、保存 Markdown |
| AI 调用 | 可选中文字、调用 AI、查看结果 |
| 版本历史 | 可查看历史版本、回退 |
| 命令面板 | Cmd+K 可触发，可搜索命令 |
| 设置 | 可配置 API Key、切换主题 |

### 9.2 设计验收

| 维度 | 标准 |
|------|------|
| 视觉 | 达到 Cursor/Linear 级别 |
| 动效 | 过渡自然、有意义 |
| 响应 | 操作有即时反馈 |
| 一致性 | 所有组件风格统一 |

### 9.3 技术验收

| 维度 | 标准 |
|------|------|
| 类型安全 | 无 any，严格模式通过 |
| 构建 | 无警告，bundle size 合理 |
| 性能 | 首屏 < 2s，交互 < 100ms |
| 打包 | 三平台安装包可用 |

---

## 十、风险与应对

| 风险 | 概率 | 影响 | 应对 |
|------|------|------|------|
| 后端接口不兼容 | 低 | 高 | 后端服务已稳定，复用现有协议 |
| FlexLayout 功能不足 | 中 | 中 | 备选：rc-dock 或自定义 |
| Electron 打包问题 | 中 | 中 | 使用成熟的 electron-vite |
| 设计质量达不到预期 | 中 | 高 | 参考 Cursor/Linear，多次迭代 |

---

## 十一、参考资源

### 11.1 设计参考

| 产品 | 学习点 |
|------|--------|
| Cursor | 深色主题、布局、命令面板 |
| Linear | 极简色彩、动效、专业感 |
| Notion | 编辑器、块级编辑 |
| Obsidian | 文件树、本地优先 |
| Arc Browser | 侧边栏、创新交互 |

### 11.2 技术文档

| 资源 | 链接 |
|------|------|
| shadcn/ui | https://ui.shadcn.com |
| Radix UI | https://radix-ui.com |
| TipTap | https://tiptap.dev |
| FlexLayout | https://github.com/caplin/FlexLayout |
| react-arborist | https://react-arborist.netlify.app |
| cmdk | https://cmdk.paco.me |
| sonner | https://sonner.emilkowal.ski |
| Framer Motion | https://motion.dev |
| electron-vite | https://electron-vite.org |

---

## 十二、执行要求

### 对执行 Agent 的要求

1. **联网搜索**：在实现每个组件前，搜索最新的最佳实践和示例
2. **参考设计**：深入研究 Cursor/Linear/Notion 的交互细节
3. **质量优先**：不赶进度，确保每个组件达到产品级质量
4. **增量验证**：每完成一个模块，先让用户验收再继续
5. **文档留痕**：重要决策记录在代码注释或设计文档中

### 对用户的要求

1. **阶段性验收**：每个 Phase 完成后查看效果
2. **明确反馈**：指出不满意的地方（颜色/间距/动效等）
3. **设计决策**：在需要时确认偏好（如主题、布局等）

---

**以上是完整的前端重构规范。执行 Agent 应按照此规范，从 Phase 0 开始逐步实施。**
